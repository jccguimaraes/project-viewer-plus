"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _uuid = _interopRequireDefault(require("uuid"));

var _atom = require("atom");

var _base = require("../constants/base");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable-next-line require-jsdoc */
class State {
  /* eslint-disable-next-line require-jsdoc */
  activate(currentState) {
    this.mapping = new Map();
    this.emitter = new _atom.Emitter();
  }
  /**
   * Clears the mapping
   */


  deactivate() {
    this.emitter.dispose();
    this.mapping.clear();
  }
  /**
   * Clears the mapping
   */


  clearState() {
    this.mapping.clear();
    this.emitter.emit('did-change-state');
  }
  /* eslint-disable-next-line require-jsdoc */


  createGroup(entry = {}, childrenIds = [], parentId = NaN) {
    return {
      type: 'group',
      name: entry.name || '',
      icon: entry.icon || '',
      order: entry.order || 'alphabetically',
      folding: entry.folding || 'collapsed',
      childrenIds,
      parentId
    };
  }
  /* eslint-disable-next-line require-jsdoc */


  createProject(entry = {}, parentId = NaN) {
    return {
      type: 'project',
      name: entry.name || '',
      icon: entry.icon || '',
      paths: entry.paths || [],
      parentId
    };
  }
  /**
   * Stores in the Map an object with valid group content. In case of the root
   * level, the object is stored with the "id" NaN.
   * @param {Object} entry - an object already validated with group content
   * @param {boolean} isRoot - indicates if this level is the root
   * @param {boolean} parentId - indicates if this level is the root
   * @returns {number} the id of the deserialized group
   */


  deserializeGroupAndReturnId(entry, isRoot, parentId) {
    const id = isRoot ? NaN : entry.id || (0, _uuid.default)();
    const childrenIds = [];
    entry.groups.forEach(group => childrenIds.push(this.deserializeGroupAndReturnId(group, false, id)));
    entry.projects.forEach(project => childrenIds.push(this.deserializeProjectAndReturnId(project, id)));
    const group = this.createGroup(entry, childrenIds, isRoot ? undefined : parentId);
    this.mapping.set(id, group);
    return id;
  }
  /**
   * Stores in the Map an object with valid group content.
   * @param {Object} entry - an object already validated with project content
   * @param {Object} parentId - an object already validated with project content
   * @returns {number} the id of the deserialized project
   */


  deserializeProjectAndReturnId(entry, parentId) {
    const id = entry.id || (0, _uuid.default)();
    const project = this.createProject(entry, parentId);
    this.mapping.set(id, project);
    return id;
  }
  /**
   * Parse state to store in cache or file
   * @param {number} id - the current id of the group (NaN for root)
   * @param {boolean} withContext - false for saving to file
   * @returns {Object} the serialized state
   */


  serializeGroupById(id, withContext = true) {
    const level = {
      groups: [],
      projects: []
    };
    const group = this.getEntry(id || NaN);

    if (!group) {
      return level;
    }

    group.childrenIds.forEach(childId => {
      const entry = this.getEntry(childId);

      if (entry.type === 'group') {
        const serializedLevel = this.serializeGroupById(childId, withContext);
        level.groups.push({ ...(withContext ? {
            id: childId
          } : {}),
          ...(withContext ? {
            parentId: id
          } : {}),
          name: entry.name,
          icon: entry.icon,
          order: entry.order,
          ...(withContext ? {
            folding: entry.folding
          } : {}),
          ...serializedLevel
        });
      } else if (entry.type === 'project') {
        level.projects.push({ ...(withContext ? {
            id: childId
          } : {}),
          ...(withContext ? {
            parentId: id
          } : {}),
          name: entry.name,
          icon: entry.icon,
          paths: entry.paths
        });
      }
    });
    return level;
  }
  /**
   * Update parcially or fully an existing entry
   * @param {string} id - the id of the existing entry
   * @param {string} state - the new state (partial parameters or all of them)
   */


  fullOrParcialUpdateExistingEntry(id, state) {
    const entry = this.getEntry(id);

    if (!entry) {
      throw new Error('unexisting_entry');
    }

    this.mapping.set(id, { ...entry,
      ...state
    });
  }
  /* eslint-disable-next-line require-jsdoc */


  getEntry(id) {
    return this.mapping.get(id);
  }
  /* eslint-disable-next-line require-jsdoc */


  deleteEntry(id) {
    const entry = this.getEntry(id);

    if (entry.type === 'group') {
      entry.childrenIds.forEach(childId => this.deleteEntry(childId));
    }

    if (entry.parentId || isNaN(entry.parentId)) {
      const group = this.getEntry(entry.parentId);
      const idx = group.childrenIds.indexOf(id);
      group.childrenIds.splice(idx, 1);
      this.fullOrParcialUpdateExistingEntry(entry.parentId, group);
    }

    this.mapping.delete(id);
    this.emitter.emit('did-change-state');
  }
  /**
   * Given an group id it will search all projects underneath it
   * @param {number} groupId - the group id to search for projects
   * @param {array} list - the container for all projects
   * @returns {array} the container for all projects
   */


  getProjectsInGroup(groupId, list = []) {
    if (this.mapping.size === 0) {
      return list;
    }

    const group = this.getEntry(groupId || NaN);

    if (!group || group.type !== 'group') {
      throw new Error('not_a_group');
    }

    return group.childrenIds.reduce((acc, entryId) => {
      const entry = this.getEntry(entryId);

      if (entry.type === 'group') {
        this.getProjectsInGroup(entryId, acc);
      } else {
        acc.push({
          id: entryId,
          name: entry.name,
          paths: entry.paths
        });
      }

      return acc;
    }, list);
  }
  /**
   * Given an group id it will search all groups underneath it
   * @param {number} groupId - the group id to search for groups
   * @param {array} list - the container for all groups
   * @returns {array} the container for all groups
   */


  getGroupsInGroup(groupId, list = []) {
    const group = this.getEntry(groupId || NaN);

    if (!group || group.type !== 'group') {
      throw new Error('not_a_group');
    }

    return group.childrenIds.reduce((acc, entryId) => {
      const entry = this.getEntry(entryId);

      if (entry.type === 'group') {
        const subList = [];
        acc.push({
          id: entryId,
          name: entry.name,
          groups: this.getGroupsInGroup(entryId, subList)
        });
      }

      return acc;
    }, list);
  }
  /* eslint-disable-next-line require-jsdoc */


  editEntry(id, newState) {
    const entry = this.getEntry(id);

    if (entry.parentId !== newState.parentId) {
      const oldParent = this.getEntry(entry.parentId);
      const newParent = this.getEntry(newState.parentId);
      oldParent.childrenIds.splice(oldParent.childrenIds.indexOf(id), 1);
      newParent.childrenIds.push(id);
    }

    this.fullOrParcialUpdateExistingEntry(id, newState);
    this.emitter.emit('did-change-state');
  }
  /* eslint-disable-next-line require-jsdoc */


  addEntry(entry) {
    if (!entry) {
      return;
    }

    const id = (0, _uuid.default)();
    this.mapping.set(id, entry);
    const parent = this.getEntry(entry.parentId);

    if (parent) {
      parent.childrenIds.push(id);
    }

    this.fullOrParcialUpdateExistingEntry(entry.parentId, parent);
    this.emitter.emit('did-change-state');
  }
  /* eslint-disable-next-line require-jsdoc */


  setParentOfEntry(entryId, parentId = NaN) {
    if (entryId === parentId || entryId === _base.DOCK_URI) {
      return;
    }

    const entry = this.getEntry(entryId);

    if (!entry) {
      return;
    }

    const oldParent = this.getEntry(entry.parentId);
    let newParent = this.getEntry(parentId);

    if (newParent.type === 'project') {
      parentId = newParent.parentId;
      newParent = this.getEntry(newParent.parentId);
    }

    oldParent.childrenIds.splice(oldParent.childrenIds.indexOf(entryId), 1);
    newParent.childrenIds.push(entryId);
    entry.parentId = parentId;
    this.fullOrParcialUpdateExistingEntry(entryId, entry);
    this.fullOrParcialUpdateExistingEntry(entry.parentId, oldParent);
    this.fullOrParcialUpdateExistingEntry(parentId, newParent);
    this.emitter.emit('did-change-state');
  }
  /* eslint-disable-next-line require-jsdoc */


  initializeState(currentState) {
    this.deserializeGroupAndReturnId(currentState, true);
    this.emitter.emit('did-change-state');
  }
  /* eslint-disable-next-line require-jsdoc */


  onDidChangeState(cb) {
    this.emitter.on('did-change-state', cb);
  }

} // same instance is shared across the package


var _default = new State();

exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9zZXJ2aWNlcy9zdGF0ZS5qcyJdLCJuYW1lcyI6WyJTdGF0ZSIsImFjdGl2YXRlIiwiY3VycmVudFN0YXRlIiwibWFwcGluZyIsIk1hcCIsImVtaXR0ZXIiLCJFbWl0dGVyIiwiZGVhY3RpdmF0ZSIsImRpc3Bvc2UiLCJjbGVhciIsImNsZWFyU3RhdGUiLCJlbWl0IiwiY3JlYXRlR3JvdXAiLCJlbnRyeSIsImNoaWxkcmVuSWRzIiwicGFyZW50SWQiLCJOYU4iLCJ0eXBlIiwibmFtZSIsImljb24iLCJvcmRlciIsImZvbGRpbmciLCJjcmVhdGVQcm9qZWN0IiwicGF0aHMiLCJkZXNlcmlhbGl6ZUdyb3VwQW5kUmV0dXJuSWQiLCJpc1Jvb3QiLCJpZCIsImdyb3VwcyIsImZvckVhY2giLCJncm91cCIsInB1c2giLCJwcm9qZWN0cyIsInByb2plY3QiLCJkZXNlcmlhbGl6ZVByb2plY3RBbmRSZXR1cm5JZCIsInVuZGVmaW5lZCIsInNldCIsInNlcmlhbGl6ZUdyb3VwQnlJZCIsIndpdGhDb250ZXh0IiwibGV2ZWwiLCJnZXRFbnRyeSIsImNoaWxkSWQiLCJzZXJpYWxpemVkTGV2ZWwiLCJmdWxsT3JQYXJjaWFsVXBkYXRlRXhpc3RpbmdFbnRyeSIsInN0YXRlIiwiRXJyb3IiLCJnZXQiLCJkZWxldGVFbnRyeSIsImlzTmFOIiwiaWR4IiwiaW5kZXhPZiIsInNwbGljZSIsImRlbGV0ZSIsImdldFByb2plY3RzSW5Hcm91cCIsImdyb3VwSWQiLCJsaXN0Iiwic2l6ZSIsInJlZHVjZSIsImFjYyIsImVudHJ5SWQiLCJnZXRHcm91cHNJbkdyb3VwIiwic3ViTGlzdCIsImVkaXRFbnRyeSIsIm5ld1N0YXRlIiwib2xkUGFyZW50IiwibmV3UGFyZW50IiwiYWRkRW50cnkiLCJwYXJlbnQiLCJzZXRQYXJlbnRPZkVudHJ5IiwiRE9DS19VUkkiLCJpbml0aWFsaXplU3RhdGUiLCJvbkRpZENoYW5nZVN0YXRlIiwiY2IiLCJvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUVBOzs7O0FBRUE7QUFDQSxNQUFNQSxLQUFOLENBQVk7QUFDVjtBQUNBQyxFQUFBQSxRQUFRLENBQUVDLFlBQUYsRUFBZ0I7QUFDdEIsU0FBS0MsT0FBTCxHQUFlLElBQUlDLEdBQUosRUFBZjtBQUNBLFNBQUtDLE9BQUwsR0FBZSxJQUFJQyxhQUFKLEVBQWY7QUFDRDtBQUVEOzs7OztBQUdBQyxFQUFBQSxVQUFVLEdBQUk7QUFDWixTQUFLRixPQUFMLENBQWFHLE9BQWI7QUFDQSxTQUFLTCxPQUFMLENBQWFNLEtBQWI7QUFDRDtBQUVEOzs7OztBQUdBQyxFQUFBQSxVQUFVLEdBQUk7QUFDWixTQUFLUCxPQUFMLENBQWFNLEtBQWI7QUFDQSxTQUFLSixPQUFMLENBQWFNLElBQWIsQ0FBa0Isa0JBQWxCO0FBQ0Q7QUFFRDs7O0FBQ0FDLEVBQUFBLFdBQVcsQ0FBRUMsS0FBSyxHQUFHLEVBQVYsRUFBY0MsV0FBVyxHQUFHLEVBQTVCLEVBQWdDQyxRQUFRLEdBQUdDLEdBQTNDLEVBQWdEO0FBQ3pELFdBQU87QUFDTEMsTUFBQUEsSUFBSSxFQUFFLE9BREQ7QUFFTEMsTUFBQUEsSUFBSSxFQUFFTCxLQUFLLENBQUNLLElBQU4sSUFBYyxFQUZmO0FBR0xDLE1BQUFBLElBQUksRUFBRU4sS0FBSyxDQUFDTSxJQUFOLElBQWMsRUFIZjtBQUlMQyxNQUFBQSxLQUFLLEVBQUVQLEtBQUssQ0FBQ08sS0FBTixJQUFlLGdCQUpqQjtBQUtMQyxNQUFBQSxPQUFPLEVBQUVSLEtBQUssQ0FBQ1EsT0FBTixJQUFpQixXQUxyQjtBQU1MUCxNQUFBQSxXQU5LO0FBT0xDLE1BQUFBO0FBUEssS0FBUDtBQVNEO0FBRUQ7OztBQUNBTyxFQUFBQSxhQUFhLENBQUVULEtBQUssR0FBRyxFQUFWLEVBQWNFLFFBQVEsR0FBR0MsR0FBekIsRUFBOEI7QUFDekMsV0FBTztBQUNMQyxNQUFBQSxJQUFJLEVBQUUsU0FERDtBQUVMQyxNQUFBQSxJQUFJLEVBQUVMLEtBQUssQ0FBQ0ssSUFBTixJQUFjLEVBRmY7QUFHTEMsTUFBQUEsSUFBSSxFQUFFTixLQUFLLENBQUNNLElBQU4sSUFBYyxFQUhmO0FBSUxJLE1BQUFBLEtBQUssRUFBRVYsS0FBSyxDQUFDVSxLQUFOLElBQWUsRUFKakI7QUFLTFIsTUFBQUE7QUFMSyxLQUFQO0FBT0Q7QUFFRDs7Ozs7Ozs7OztBQVFBUyxFQUFBQSwyQkFBMkIsQ0FBRVgsS0FBRixFQUFTWSxNQUFULEVBQWlCVixRQUFqQixFQUEyQjtBQUNwRCxVQUFNVyxFQUFFLEdBQUdELE1BQU0sR0FBR1QsR0FBSCxHQUFTSCxLQUFLLENBQUNhLEVBQU4sSUFBWSxvQkFBdEM7QUFDQSxVQUFNWixXQUFXLEdBQUcsRUFBcEI7QUFFQUQsSUFBQUEsS0FBSyxDQUFDYyxNQUFOLENBQWFDLE9BQWIsQ0FBcUJDLEtBQUssSUFDeEJmLFdBQVcsQ0FBQ2dCLElBQVosQ0FBaUIsS0FBS04sMkJBQUwsQ0FBaUNLLEtBQWpDLEVBQXdDLEtBQXhDLEVBQStDSCxFQUEvQyxDQUFqQixDQURGO0FBSUFiLElBQUFBLEtBQUssQ0FBQ2tCLFFBQU4sQ0FBZUgsT0FBZixDQUF1QkksT0FBTyxJQUM1QmxCLFdBQVcsQ0FBQ2dCLElBQVosQ0FBaUIsS0FBS0csNkJBQUwsQ0FBbUNELE9BQW5DLEVBQTRDTixFQUE1QyxDQUFqQixDQURGO0FBSUEsVUFBTUcsS0FBSyxHQUFHLEtBQUtqQixXQUFMLENBQ1pDLEtBRFksRUFFWkMsV0FGWSxFQUdaVyxNQUFNLEdBQUdTLFNBQUgsR0FBZW5CLFFBSFQsQ0FBZDtBQU1BLFNBQUtaLE9BQUwsQ0FBYWdDLEdBQWIsQ0FBaUJULEVBQWpCLEVBQXFCRyxLQUFyQjtBQUVBLFdBQU9ILEVBQVA7QUFDRDtBQUVEOzs7Ozs7OztBQU1BTyxFQUFBQSw2QkFBNkIsQ0FBRXBCLEtBQUYsRUFBU0UsUUFBVCxFQUFtQjtBQUM5QyxVQUFNVyxFQUFFLEdBQUdiLEtBQUssQ0FBQ2EsRUFBTixJQUFZLG9CQUF2QjtBQUNBLFVBQU1NLE9BQU8sR0FBRyxLQUFLVixhQUFMLENBQW1CVCxLQUFuQixFQUEwQkUsUUFBMUIsQ0FBaEI7QUFFQSxTQUFLWixPQUFMLENBQWFnQyxHQUFiLENBQWlCVCxFQUFqQixFQUFxQk0sT0FBckI7QUFFQSxXQUFPTixFQUFQO0FBQ0Q7QUFFRDs7Ozs7Ozs7QUFNQVUsRUFBQUEsa0JBQWtCLENBQUVWLEVBQUYsRUFBTVcsV0FBVyxHQUFHLElBQXBCLEVBQTBCO0FBQzFDLFVBQU1DLEtBQUssR0FBRztBQUFFWCxNQUFBQSxNQUFNLEVBQUUsRUFBVjtBQUFjSSxNQUFBQSxRQUFRLEVBQUU7QUFBeEIsS0FBZDtBQUVBLFVBQU1GLEtBQUssR0FBRyxLQUFLVSxRQUFMLENBQWNiLEVBQUUsSUFBSVYsR0FBcEIsQ0FBZDs7QUFFQSxRQUFJLENBQUNhLEtBQUwsRUFBWTtBQUNWLGFBQU9TLEtBQVA7QUFDRDs7QUFFRFQsSUFBQUEsS0FBSyxDQUFDZixXQUFOLENBQWtCYyxPQUFsQixDQUEwQlksT0FBTyxJQUFJO0FBQ25DLFlBQU0zQixLQUFLLEdBQUcsS0FBSzBCLFFBQUwsQ0FBY0MsT0FBZCxDQUFkOztBQUVBLFVBQUkzQixLQUFLLENBQUNJLElBQU4sS0FBZSxPQUFuQixFQUE0QjtBQUMxQixjQUFNd0IsZUFBZSxHQUFHLEtBQUtMLGtCQUFMLENBQXdCSSxPQUF4QixFQUFpQ0gsV0FBakMsQ0FBeEI7QUFFQUMsUUFBQUEsS0FBSyxDQUFDWCxNQUFOLENBQWFHLElBQWIsQ0FBa0IsRUFDaEIsSUFBR08sV0FBVyxHQUFHO0FBQUVYLFlBQUFBLEVBQUUsRUFBRWM7QUFBTixXQUFILEdBQXFCLEVBQW5DLENBRGdCO0FBRWhCLGNBQUdILFdBQVcsR0FBRztBQUFFdEIsWUFBQUEsUUFBUSxFQUFFVztBQUFaLFdBQUgsR0FBc0IsRUFBcEMsQ0FGZ0I7QUFHaEJSLFVBQUFBLElBQUksRUFBRUwsS0FBSyxDQUFDSyxJQUhJO0FBSWhCQyxVQUFBQSxJQUFJLEVBQUVOLEtBQUssQ0FBQ00sSUFKSTtBQUtoQkMsVUFBQUEsS0FBSyxFQUFFUCxLQUFLLENBQUNPLEtBTEc7QUFNaEIsY0FBR2lCLFdBQVcsR0FBRztBQUFFaEIsWUFBQUEsT0FBTyxFQUFFUixLQUFLLENBQUNRO0FBQWpCLFdBQUgsR0FBZ0MsRUFBOUMsQ0FOZ0I7QUFPaEIsYUFBR29CO0FBUGEsU0FBbEI7QUFTRCxPQVpELE1BYUssSUFBSTVCLEtBQUssQ0FBQ0ksSUFBTixLQUFlLFNBQW5CLEVBQThCO0FBQ2pDcUIsUUFBQUEsS0FBSyxDQUFDUCxRQUFOLENBQWVELElBQWYsQ0FBb0IsRUFDbEIsSUFBR08sV0FBVyxHQUFHO0FBQUVYLFlBQUFBLEVBQUUsRUFBRWM7QUFBTixXQUFILEdBQXFCLEVBQW5DLENBRGtCO0FBRWxCLGNBQUdILFdBQVcsR0FBRztBQUFFdEIsWUFBQUEsUUFBUSxFQUFFVztBQUFaLFdBQUgsR0FBc0IsRUFBcEMsQ0FGa0I7QUFHbEJSLFVBQUFBLElBQUksRUFBRUwsS0FBSyxDQUFDSyxJQUhNO0FBSWxCQyxVQUFBQSxJQUFJLEVBQUVOLEtBQUssQ0FBQ00sSUFKTTtBQUtsQkksVUFBQUEsS0FBSyxFQUFFVixLQUFLLENBQUNVO0FBTEssU0FBcEI7QUFPRDtBQUNGLEtBekJEO0FBMkJBLFdBQU9lLEtBQVA7QUFDRDtBQUVEOzs7Ozs7O0FBS0FJLEVBQUFBLGdDQUFnQyxDQUFFaEIsRUFBRixFQUFNaUIsS0FBTixFQUFhO0FBQzNDLFVBQU05QixLQUFLLEdBQUcsS0FBSzBCLFFBQUwsQ0FBY2IsRUFBZCxDQUFkOztBQUVBLFFBQUksQ0FBQ2IsS0FBTCxFQUFZO0FBQ1YsWUFBTSxJQUFJK0IsS0FBSixDQUFVLGtCQUFWLENBQU47QUFDRDs7QUFFRCxTQUFLekMsT0FBTCxDQUFhZ0MsR0FBYixDQUFpQlQsRUFBakIsRUFBcUIsRUFDbkIsR0FBR2IsS0FEZ0I7QUFFbkIsU0FBRzhCO0FBRmdCLEtBQXJCO0FBSUQ7QUFFRDs7O0FBQ0FKLEVBQUFBLFFBQVEsQ0FBRWIsRUFBRixFQUFNO0FBQ1osV0FBTyxLQUFLdkIsT0FBTCxDQUFhMEMsR0FBYixDQUFpQm5CLEVBQWpCLENBQVA7QUFDRDtBQUVEOzs7QUFDQW9CLEVBQUFBLFdBQVcsQ0FBRXBCLEVBQUYsRUFBTTtBQUNmLFVBQU1iLEtBQUssR0FBRyxLQUFLMEIsUUFBTCxDQUFjYixFQUFkLENBQWQ7O0FBRUEsUUFBSWIsS0FBSyxDQUFDSSxJQUFOLEtBQWUsT0FBbkIsRUFBNEI7QUFDMUJKLE1BQUFBLEtBQUssQ0FBQ0MsV0FBTixDQUFrQmMsT0FBbEIsQ0FBMEJZLE9BQU8sSUFBSSxLQUFLTSxXQUFMLENBQWlCTixPQUFqQixDQUFyQztBQUNEOztBQUVELFFBQUkzQixLQUFLLENBQUNFLFFBQU4sSUFBa0JnQyxLQUFLLENBQUNsQyxLQUFLLENBQUNFLFFBQVAsQ0FBM0IsRUFBNkM7QUFDM0MsWUFBTWMsS0FBSyxHQUFHLEtBQUtVLFFBQUwsQ0FBYzFCLEtBQUssQ0FBQ0UsUUFBcEIsQ0FBZDtBQUNBLFlBQU1pQyxHQUFHLEdBQUduQixLQUFLLENBQUNmLFdBQU4sQ0FBa0JtQyxPQUFsQixDQUEwQnZCLEVBQTFCLENBQVo7QUFDQUcsTUFBQUEsS0FBSyxDQUFDZixXQUFOLENBQWtCb0MsTUFBbEIsQ0FBeUJGLEdBQXpCLEVBQThCLENBQTlCO0FBQ0EsV0FBS04sZ0NBQUwsQ0FBc0M3QixLQUFLLENBQUNFLFFBQTVDLEVBQXNEYyxLQUF0RDtBQUNEOztBQUVELFNBQUsxQixPQUFMLENBQWFnRCxNQUFiLENBQW9CekIsRUFBcEI7QUFDQSxTQUFLckIsT0FBTCxDQUFhTSxJQUFiLENBQWtCLGtCQUFsQjtBQUNEO0FBRUQ7Ozs7Ozs7O0FBTUF5QyxFQUFBQSxrQkFBa0IsQ0FBRUMsT0FBRixFQUFXQyxJQUFJLEdBQUcsRUFBbEIsRUFBc0I7QUFDdEMsUUFBSSxLQUFLbkQsT0FBTCxDQUFhb0QsSUFBYixLQUFzQixDQUExQixFQUE2QjtBQUMzQixhQUFPRCxJQUFQO0FBQ0Q7O0FBRUQsVUFBTXpCLEtBQUssR0FBRyxLQUFLVSxRQUFMLENBQWNjLE9BQU8sSUFBSXJDLEdBQXpCLENBQWQ7O0FBRUEsUUFBSSxDQUFDYSxLQUFELElBQVVBLEtBQUssQ0FBQ1osSUFBTixLQUFlLE9BQTdCLEVBQXNDO0FBQ3BDLFlBQU0sSUFBSTJCLEtBQUosQ0FBVSxhQUFWLENBQU47QUFDRDs7QUFFRCxXQUFPZixLQUFLLENBQUNmLFdBQU4sQ0FBa0IwQyxNQUFsQixDQUF5QixDQUFDQyxHQUFELEVBQU1DLE9BQU4sS0FBa0I7QUFDaEQsWUFBTTdDLEtBQUssR0FBRyxLQUFLMEIsUUFBTCxDQUFjbUIsT0FBZCxDQUFkOztBQUNBLFVBQUk3QyxLQUFLLENBQUNJLElBQU4sS0FBZSxPQUFuQixFQUE0QjtBQUMxQixhQUFLbUMsa0JBQUwsQ0FBd0JNLE9BQXhCLEVBQWlDRCxHQUFqQztBQUNELE9BRkQsTUFHSztBQUNIQSxRQUFBQSxHQUFHLENBQUMzQixJQUFKLENBQVM7QUFDUEosVUFBQUEsRUFBRSxFQUFFZ0MsT0FERztBQUVQeEMsVUFBQUEsSUFBSSxFQUFFTCxLQUFLLENBQUNLLElBRkw7QUFHUEssVUFBQUEsS0FBSyxFQUFFVixLQUFLLENBQUNVO0FBSE4sU0FBVDtBQUtEOztBQUVELGFBQU9rQyxHQUFQO0FBQ0QsS0FkTSxFQWNKSCxJQWRJLENBQVA7QUFlRDtBQUVEOzs7Ozs7OztBQU1BSyxFQUFBQSxnQkFBZ0IsQ0FBRU4sT0FBRixFQUFXQyxJQUFJLEdBQUcsRUFBbEIsRUFBc0I7QUFDcEMsVUFBTXpCLEtBQUssR0FBRyxLQUFLVSxRQUFMLENBQWNjLE9BQU8sSUFBSXJDLEdBQXpCLENBQWQ7O0FBRUEsUUFBSSxDQUFDYSxLQUFELElBQVVBLEtBQUssQ0FBQ1osSUFBTixLQUFlLE9BQTdCLEVBQXNDO0FBQ3BDLFlBQU0sSUFBSTJCLEtBQUosQ0FBVSxhQUFWLENBQU47QUFDRDs7QUFFRCxXQUFPZixLQUFLLENBQUNmLFdBQU4sQ0FBa0IwQyxNQUFsQixDQUF5QixDQUFDQyxHQUFELEVBQU1DLE9BQU4sS0FBa0I7QUFDaEQsWUFBTTdDLEtBQUssR0FBRyxLQUFLMEIsUUFBTCxDQUFjbUIsT0FBZCxDQUFkOztBQUNBLFVBQUk3QyxLQUFLLENBQUNJLElBQU4sS0FBZSxPQUFuQixFQUE0QjtBQUMxQixjQUFNMkMsT0FBTyxHQUFHLEVBQWhCO0FBRUFILFFBQUFBLEdBQUcsQ0FBQzNCLElBQUosQ0FBUztBQUNQSixVQUFBQSxFQUFFLEVBQUVnQyxPQURHO0FBRVB4QyxVQUFBQSxJQUFJLEVBQUVMLEtBQUssQ0FBQ0ssSUFGTDtBQUdQUyxVQUFBQSxNQUFNLEVBQUUsS0FBS2dDLGdCQUFMLENBQXVCRCxPQUF2QixFQUFnQ0UsT0FBaEM7QUFIRCxTQUFUO0FBS0Q7O0FBRUQsYUFBT0gsR0FBUDtBQUNELEtBYk0sRUFhSkgsSUFiSSxDQUFQO0FBY0Q7QUFFRDs7O0FBQ0FPLEVBQUFBLFNBQVMsQ0FBRW5DLEVBQUYsRUFBTW9DLFFBQU4sRUFBZ0I7QUFDdkIsVUFBTWpELEtBQUssR0FBRyxLQUFLMEIsUUFBTCxDQUFjYixFQUFkLENBQWQ7O0FBRUEsUUFBSWIsS0FBSyxDQUFDRSxRQUFOLEtBQW1CK0MsUUFBUSxDQUFDL0MsUUFBaEMsRUFBMEM7QUFDeEMsWUFBTWdELFNBQVMsR0FBRyxLQUFLeEIsUUFBTCxDQUFjMUIsS0FBSyxDQUFDRSxRQUFwQixDQUFsQjtBQUNBLFlBQU1pRCxTQUFTLEdBQUcsS0FBS3pCLFFBQUwsQ0FBY3VCLFFBQVEsQ0FBQy9DLFFBQXZCLENBQWxCO0FBRUFnRCxNQUFBQSxTQUFTLENBQUNqRCxXQUFWLENBQXNCb0MsTUFBdEIsQ0FBNkJhLFNBQVMsQ0FBQ2pELFdBQVYsQ0FBc0JtQyxPQUF0QixDQUE4QnZCLEVBQTlCLENBQTdCLEVBQWdFLENBQWhFO0FBQ0FzQyxNQUFBQSxTQUFTLENBQUNsRCxXQUFWLENBQXNCZ0IsSUFBdEIsQ0FBMkJKLEVBQTNCO0FBQ0Q7O0FBRUQsU0FBS2dCLGdDQUFMLENBQXNDaEIsRUFBdEMsRUFBMENvQyxRQUExQztBQUNBLFNBQUt6RCxPQUFMLENBQWFNLElBQWIsQ0FBa0Isa0JBQWxCO0FBQ0Q7QUFFRDs7O0FBQ0FzRCxFQUFBQSxRQUFRLENBQUVwRCxLQUFGLEVBQVM7QUFDZixRQUFJLENBQUNBLEtBQUwsRUFBWTtBQUNWO0FBQ0Q7O0FBRUQsVUFBTWEsRUFBRSxHQUFHLG9CQUFYO0FBRUEsU0FBS3ZCLE9BQUwsQ0FBYWdDLEdBQWIsQ0FBaUJULEVBQWpCLEVBQXFCYixLQUFyQjtBQUNBLFVBQU1xRCxNQUFNLEdBQUcsS0FBSzNCLFFBQUwsQ0FBYzFCLEtBQUssQ0FBQ0UsUUFBcEIsQ0FBZjs7QUFFQSxRQUFJbUQsTUFBSixFQUFZO0FBQ1ZBLE1BQUFBLE1BQU0sQ0FBQ3BELFdBQVAsQ0FBbUJnQixJQUFuQixDQUF3QkosRUFBeEI7QUFDRDs7QUFFRCxTQUFLZ0IsZ0NBQUwsQ0FBc0M3QixLQUFLLENBQUNFLFFBQTVDLEVBQXNEbUQsTUFBdEQ7QUFFQSxTQUFLN0QsT0FBTCxDQUFhTSxJQUFiLENBQWtCLGtCQUFsQjtBQUNEO0FBRUQ7OztBQUNBd0QsRUFBQUEsZ0JBQWdCLENBQUVULE9BQUYsRUFBVzNDLFFBQVEsR0FBR0MsR0FBdEIsRUFBMkI7QUFDekMsUUFBSTBDLE9BQU8sS0FBSzNDLFFBQVosSUFBd0IyQyxPQUFPLEtBQUtVLGNBQXhDLEVBQWtEO0FBQ2hEO0FBQ0Q7O0FBQ0QsVUFBTXZELEtBQUssR0FBRyxLQUFLMEIsUUFBTCxDQUFjbUIsT0FBZCxDQUFkOztBQUVBLFFBQUksQ0FBQzdDLEtBQUwsRUFBWTtBQUNWO0FBQ0Q7O0FBRUQsVUFBTWtELFNBQVMsR0FBRyxLQUFLeEIsUUFBTCxDQUFjMUIsS0FBSyxDQUFDRSxRQUFwQixDQUFsQjtBQUVBLFFBQUlpRCxTQUFTLEdBQUcsS0FBS3pCLFFBQUwsQ0FBY3hCLFFBQWQsQ0FBaEI7O0FBRUEsUUFBSWlELFNBQVMsQ0FBQy9DLElBQVYsS0FBbUIsU0FBdkIsRUFBa0M7QUFDaENGLE1BQUFBLFFBQVEsR0FBR2lELFNBQVMsQ0FBQ2pELFFBQXJCO0FBQ0FpRCxNQUFBQSxTQUFTLEdBQUcsS0FBS3pCLFFBQUwsQ0FBY3lCLFNBQVMsQ0FBQ2pELFFBQXhCLENBQVo7QUFDRDs7QUFFRGdELElBQUFBLFNBQVMsQ0FBQ2pELFdBQVYsQ0FBc0JvQyxNQUF0QixDQUE2QmEsU0FBUyxDQUFDakQsV0FBVixDQUFzQm1DLE9BQXRCLENBQThCUyxPQUE5QixDQUE3QixFQUFxRSxDQUFyRTtBQUVBTSxJQUFBQSxTQUFTLENBQUNsRCxXQUFWLENBQXNCZ0IsSUFBdEIsQ0FBMkI0QixPQUEzQjtBQUVBN0MsSUFBQUEsS0FBSyxDQUFDRSxRQUFOLEdBQWlCQSxRQUFqQjtBQUVBLFNBQUsyQixnQ0FBTCxDQUFzQ2dCLE9BQXRDLEVBQStDN0MsS0FBL0M7QUFDQSxTQUFLNkIsZ0NBQUwsQ0FBc0M3QixLQUFLLENBQUNFLFFBQTVDLEVBQXNEZ0QsU0FBdEQ7QUFDQSxTQUFLckIsZ0NBQUwsQ0FBc0MzQixRQUF0QyxFQUFnRGlELFNBQWhEO0FBRUEsU0FBSzNELE9BQUwsQ0FBYU0sSUFBYixDQUFrQixrQkFBbEI7QUFDRDtBQUVEOzs7QUFDQTBELEVBQUFBLGVBQWUsQ0FBRW5FLFlBQUYsRUFBZ0I7QUFDN0IsU0FBS3NCLDJCQUFMLENBQWlDdEIsWUFBakMsRUFBK0MsSUFBL0M7QUFDQSxTQUFLRyxPQUFMLENBQWFNLElBQWIsQ0FBa0Isa0JBQWxCO0FBQ0Q7QUFFRDs7O0FBQ0EyRCxFQUFBQSxnQkFBZ0IsQ0FBRUMsRUFBRixFQUFNO0FBQ3BCLFNBQUtsRSxPQUFMLENBQWFtRSxFQUFiLENBQWdCLGtCQUFoQixFQUFvQ0QsRUFBcEM7QUFDRDs7QUFqVVMsQyxDQW9VWjs7O2VBQ2UsSUFBSXZFLEtBQUosRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB1dWlkIGZyb20gJ3V1aWQnO1xuaW1wb3J0IHsgRW1pdHRlciB9IGZyb20gJ2F0b20nO1xuXG5pbXBvcnQgeyBET0NLX1VSSSB9IGZyb20gJy4uL2NvbnN0YW50cy9iYXNlJztcblxuLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlcXVpcmUtanNkb2MgKi9cbmNsYXNzIFN0YXRlIHtcbiAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlcXVpcmUtanNkb2MgKi9cbiAgYWN0aXZhdGUgKGN1cnJlbnRTdGF0ZSkge1xuICAgIHRoaXMubWFwcGluZyA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFycyB0aGUgbWFwcGluZ1xuICAgKi9cbiAgZGVhY3RpdmF0ZSAoKSB7XG4gICAgdGhpcy5lbWl0dGVyLmRpc3Bvc2UoKTtcbiAgICB0aGlzLm1hcHBpbmcuY2xlYXIoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhcnMgdGhlIG1hcHBpbmdcbiAgICovXG4gIGNsZWFyU3RhdGUgKCkge1xuICAgIHRoaXMubWFwcGluZy5jbGVhcigpO1xuICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtY2hhbmdlLXN0YXRlJyk7XG4gIH1cblxuICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVxdWlyZS1qc2RvYyAqL1xuICBjcmVhdGVHcm91cCAoZW50cnkgPSB7fSwgY2hpbGRyZW5JZHMgPSBbXSwgcGFyZW50SWQgPSBOYU4pIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogJ2dyb3VwJyxcbiAgICAgIG5hbWU6IGVudHJ5Lm5hbWUgfHwgJycsXG4gICAgICBpY29uOiBlbnRyeS5pY29uIHx8ICcnLFxuICAgICAgb3JkZXI6IGVudHJ5Lm9yZGVyIHx8ICdhbHBoYWJldGljYWxseScsXG4gICAgICBmb2xkaW5nOiBlbnRyeS5mb2xkaW5nIHx8ICdjb2xsYXBzZWQnLFxuICAgICAgY2hpbGRyZW5JZHMsXG4gICAgICBwYXJlbnRJZFxuICAgIH07XG4gIH1cblxuICAvKiBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVxdWlyZS1qc2RvYyAqL1xuICBjcmVhdGVQcm9qZWN0IChlbnRyeSA9IHt9LCBwYXJlbnRJZCA9IE5hTikge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiAncHJvamVjdCcsXG4gICAgICBuYW1lOiBlbnRyeS5uYW1lIHx8ICcnLFxuICAgICAgaWNvbjogZW50cnkuaWNvbiB8fCAnJyxcbiAgICAgIHBhdGhzOiBlbnRyeS5wYXRocyB8fCBbXSxcbiAgICAgIHBhcmVudElkXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9yZXMgaW4gdGhlIE1hcCBhbiBvYmplY3Qgd2l0aCB2YWxpZCBncm91cCBjb250ZW50LiBJbiBjYXNlIG9mIHRoZSByb290XG4gICAqIGxldmVsLCB0aGUgb2JqZWN0IGlzIHN0b3JlZCB3aXRoIHRoZSBcImlkXCIgTmFOLlxuICAgKiBAcGFyYW0ge09iamVjdH0gZW50cnkgLSBhbiBvYmplY3QgYWxyZWFkeSB2YWxpZGF0ZWQgd2l0aCBncm91cCBjb250ZW50XG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNSb290IC0gaW5kaWNhdGVzIGlmIHRoaXMgbGV2ZWwgaXMgdGhlIHJvb3RcbiAgICogQHBhcmFtIHtib29sZWFufSBwYXJlbnRJZCAtIGluZGljYXRlcyBpZiB0aGlzIGxldmVsIGlzIHRoZSByb290XG4gICAqIEByZXR1cm5zIHtudW1iZXJ9IHRoZSBpZCBvZiB0aGUgZGVzZXJpYWxpemVkIGdyb3VwXG4gICAqL1xuICBkZXNlcmlhbGl6ZUdyb3VwQW5kUmV0dXJuSWQgKGVudHJ5LCBpc1Jvb3QsIHBhcmVudElkKSB7XG4gICAgY29uc3QgaWQgPSBpc1Jvb3QgPyBOYU4gOiBlbnRyeS5pZCB8fCB1dWlkKCk7XG4gICAgY29uc3QgY2hpbGRyZW5JZHMgPSBbXTtcblxuICAgIGVudHJ5Lmdyb3Vwcy5mb3JFYWNoKGdyb3VwID0+XG4gICAgICBjaGlsZHJlbklkcy5wdXNoKHRoaXMuZGVzZXJpYWxpemVHcm91cEFuZFJldHVybklkKGdyb3VwLCBmYWxzZSwgaWQpKVxuICAgICk7XG5cbiAgICBlbnRyeS5wcm9qZWN0cy5mb3JFYWNoKHByb2plY3QgPT5cbiAgICAgIGNoaWxkcmVuSWRzLnB1c2godGhpcy5kZXNlcmlhbGl6ZVByb2plY3RBbmRSZXR1cm5JZChwcm9qZWN0LCBpZCkpXG4gICAgKTtcblxuICAgIGNvbnN0IGdyb3VwID0gdGhpcy5jcmVhdGVHcm91cChcbiAgICAgIGVudHJ5LFxuICAgICAgY2hpbGRyZW5JZHMsXG4gICAgICBpc1Jvb3QgPyB1bmRlZmluZWQgOiBwYXJlbnRJZFxuICAgICk7XG5cbiAgICB0aGlzLm1hcHBpbmcuc2V0KGlkLCBncm91cCk7XG5cbiAgICByZXR1cm4gaWQ7XG4gIH1cblxuICAvKipcbiAgICogU3RvcmVzIGluIHRoZSBNYXAgYW4gb2JqZWN0IHdpdGggdmFsaWQgZ3JvdXAgY29udGVudC5cbiAgICogQHBhcmFtIHtPYmplY3R9IGVudHJ5IC0gYW4gb2JqZWN0IGFscmVhZHkgdmFsaWRhdGVkIHdpdGggcHJvamVjdCBjb250ZW50XG4gICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJlbnRJZCAtIGFuIG9iamVjdCBhbHJlYWR5IHZhbGlkYXRlZCB3aXRoIHByb2plY3QgY29udGVudFxuICAgKiBAcmV0dXJucyB7bnVtYmVyfSB0aGUgaWQgb2YgdGhlIGRlc2VyaWFsaXplZCBwcm9qZWN0XG4gICAqL1xuICBkZXNlcmlhbGl6ZVByb2plY3RBbmRSZXR1cm5JZCAoZW50cnksIHBhcmVudElkKSB7XG4gICAgY29uc3QgaWQgPSBlbnRyeS5pZCB8fCB1dWlkKCk7XG4gICAgY29uc3QgcHJvamVjdCA9IHRoaXMuY3JlYXRlUHJvamVjdChlbnRyeSwgcGFyZW50SWQpO1xuXG4gICAgdGhpcy5tYXBwaW5nLnNldChpZCwgcHJvamVjdCk7XG5cbiAgICByZXR1cm4gaWQ7XG4gIH1cblxuICAvKipcbiAgICogUGFyc2Ugc3RhdGUgdG8gc3RvcmUgaW4gY2FjaGUgb3IgZmlsZVxuICAgKiBAcGFyYW0ge251bWJlcn0gaWQgLSB0aGUgY3VycmVudCBpZCBvZiB0aGUgZ3JvdXAgKE5hTiBmb3Igcm9vdClcbiAgICogQHBhcmFtIHtib29sZWFufSB3aXRoQ29udGV4dCAtIGZhbHNlIGZvciBzYXZpbmcgdG8gZmlsZVxuICAgKiBAcmV0dXJucyB7T2JqZWN0fSB0aGUgc2VyaWFsaXplZCBzdGF0ZVxuICAgKi9cbiAgc2VyaWFsaXplR3JvdXBCeUlkIChpZCwgd2l0aENvbnRleHQgPSB0cnVlKSB7XG4gICAgY29uc3QgbGV2ZWwgPSB7IGdyb3VwczogW10sIHByb2plY3RzOiBbXSB9O1xuXG4gICAgY29uc3QgZ3JvdXAgPSB0aGlzLmdldEVudHJ5KGlkIHx8IE5hTik7XG5cbiAgICBpZiAoIWdyb3VwKSB7XG4gICAgICByZXR1cm4gbGV2ZWw7XG4gICAgfVxuXG4gICAgZ3JvdXAuY2hpbGRyZW5JZHMuZm9yRWFjaChjaGlsZElkID0+IHtcbiAgICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5nZXRFbnRyeShjaGlsZElkKTtcblxuICAgICAgaWYgKGVudHJ5LnR5cGUgPT09ICdncm91cCcpIHtcbiAgICAgICAgY29uc3Qgc2VyaWFsaXplZExldmVsID0gdGhpcy5zZXJpYWxpemVHcm91cEJ5SWQoY2hpbGRJZCwgd2l0aENvbnRleHQpO1xuXG4gICAgICAgIGxldmVsLmdyb3Vwcy5wdXNoKHtcbiAgICAgICAgICAuLi53aXRoQ29udGV4dCA/IHsgaWQ6IGNoaWxkSWQgfSA6IHt9LFxuICAgICAgICAgIC4uLndpdGhDb250ZXh0ID8geyBwYXJlbnRJZDogaWQgfSA6IHt9LFxuICAgICAgICAgIG5hbWU6IGVudHJ5Lm5hbWUsXG4gICAgICAgICAgaWNvbjogZW50cnkuaWNvbixcbiAgICAgICAgICBvcmRlcjogZW50cnkub3JkZXIsXG4gICAgICAgICAgLi4ud2l0aENvbnRleHQgPyB7IGZvbGRpbmc6IGVudHJ5LmZvbGRpbmcgfSA6IHt9LFxuICAgICAgICAgIC4uLnNlcmlhbGl6ZWRMZXZlbFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKGVudHJ5LnR5cGUgPT09ICdwcm9qZWN0Jykge1xuICAgICAgICBsZXZlbC5wcm9qZWN0cy5wdXNoKHtcbiAgICAgICAgICAuLi53aXRoQ29udGV4dCA/IHsgaWQ6IGNoaWxkSWQgfSA6IHt9LFxuICAgICAgICAgIC4uLndpdGhDb250ZXh0ID8geyBwYXJlbnRJZDogaWQgfSA6IHt9LFxuICAgICAgICAgIG5hbWU6IGVudHJ5Lm5hbWUsXG4gICAgICAgICAgaWNvbjogZW50cnkuaWNvbixcbiAgICAgICAgICBwYXRoczogZW50cnkucGF0aHNcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gbGV2ZWw7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIHBhcmNpYWxseSBvciBmdWxseSBhbiBleGlzdGluZyBlbnRyeVxuICAgKiBAcGFyYW0ge3N0cmluZ30gaWQgLSB0aGUgaWQgb2YgdGhlIGV4aXN0aW5nIGVudHJ5XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzdGF0ZSAtIHRoZSBuZXcgc3RhdGUgKHBhcnRpYWwgcGFyYW1ldGVycyBvciBhbGwgb2YgdGhlbSlcbiAgICovXG4gIGZ1bGxPclBhcmNpYWxVcGRhdGVFeGlzdGluZ0VudHJ5IChpZCwgc3RhdGUpIHtcbiAgICBjb25zdCBlbnRyeSA9IHRoaXMuZ2V0RW50cnkoaWQpO1xuXG4gICAgaWYgKCFlbnRyeSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCd1bmV4aXN0aW5nX2VudHJ5Jyk7XG4gICAgfVxuXG4gICAgdGhpcy5tYXBwaW5nLnNldChpZCwge1xuICAgICAgLi4uZW50cnksXG4gICAgICAuLi5zdGF0ZVxuICAgIH0pO1xuICB9XG5cbiAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlcXVpcmUtanNkb2MgKi9cbiAgZ2V0RW50cnkgKGlkKSB7XG4gICAgcmV0dXJuIHRoaXMubWFwcGluZy5nZXQoaWQpO1xuICB9XG5cbiAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlcXVpcmUtanNkb2MgKi9cbiAgZGVsZXRlRW50cnkgKGlkKSB7XG4gICAgY29uc3QgZW50cnkgPSB0aGlzLmdldEVudHJ5KGlkKTtcblxuICAgIGlmIChlbnRyeS50eXBlID09PSAnZ3JvdXAnKSB7XG4gICAgICBlbnRyeS5jaGlsZHJlbklkcy5mb3JFYWNoKGNoaWxkSWQgPT4gdGhpcy5kZWxldGVFbnRyeShjaGlsZElkKSk7XG4gICAgfVxuXG4gICAgaWYgKGVudHJ5LnBhcmVudElkIHx8IGlzTmFOKGVudHJ5LnBhcmVudElkKSkge1xuICAgICAgY29uc3QgZ3JvdXAgPSB0aGlzLmdldEVudHJ5KGVudHJ5LnBhcmVudElkKTtcbiAgICAgIGNvbnN0IGlkeCA9IGdyb3VwLmNoaWxkcmVuSWRzLmluZGV4T2YoaWQpO1xuICAgICAgZ3JvdXAuY2hpbGRyZW5JZHMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICB0aGlzLmZ1bGxPclBhcmNpYWxVcGRhdGVFeGlzdGluZ0VudHJ5KGVudHJ5LnBhcmVudElkLCBncm91cCk7XG4gICAgfVxuXG4gICAgdGhpcy5tYXBwaW5nLmRlbGV0ZShpZCk7XG4gICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1jaGFuZ2Utc3RhdGUnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHaXZlbiBhbiBncm91cCBpZCBpdCB3aWxsIHNlYXJjaCBhbGwgcHJvamVjdHMgdW5kZXJuZWF0aCBpdFxuICAgKiBAcGFyYW0ge251bWJlcn0gZ3JvdXBJZCAtIHRoZSBncm91cCBpZCB0byBzZWFyY2ggZm9yIHByb2plY3RzXG4gICAqIEBwYXJhbSB7YXJyYXl9IGxpc3QgLSB0aGUgY29udGFpbmVyIGZvciBhbGwgcHJvamVjdHNcbiAgICogQHJldHVybnMge2FycmF5fSB0aGUgY29udGFpbmVyIGZvciBhbGwgcHJvamVjdHNcbiAgICovXG4gIGdldFByb2plY3RzSW5Hcm91cCAoZ3JvdXBJZCwgbGlzdCA9IFtdKSB7XG4gICAgaWYgKHRoaXMubWFwcGluZy5zaXplID09PSAwKSB7XG4gICAgICByZXR1cm4gbGlzdDtcbiAgICB9XG5cbiAgICBjb25zdCBncm91cCA9IHRoaXMuZ2V0RW50cnkoZ3JvdXBJZCB8fCBOYU4pO1xuXG4gICAgaWYgKCFncm91cCB8fCBncm91cC50eXBlICE9PSAnZ3JvdXAnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ25vdF9hX2dyb3VwJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGdyb3VwLmNoaWxkcmVuSWRzLnJlZHVjZSgoYWNjLCBlbnRyeUlkKSA9PiB7XG4gICAgICBjb25zdCBlbnRyeSA9IHRoaXMuZ2V0RW50cnkoZW50cnlJZCk7XG4gICAgICBpZiAoZW50cnkudHlwZSA9PT0gJ2dyb3VwJykge1xuICAgICAgICB0aGlzLmdldFByb2plY3RzSW5Hcm91cChlbnRyeUlkLCBhY2MpO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIGFjYy5wdXNoKHtcbiAgICAgICAgICBpZDogZW50cnlJZCxcbiAgICAgICAgICBuYW1lOiBlbnRyeS5uYW1lLFxuICAgICAgICAgIHBhdGhzOiBlbnRyeS5wYXRoc1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCBsaXN0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHaXZlbiBhbiBncm91cCBpZCBpdCB3aWxsIHNlYXJjaCBhbGwgZ3JvdXBzIHVuZGVybmVhdGggaXRcbiAgICogQHBhcmFtIHtudW1iZXJ9IGdyb3VwSWQgLSB0aGUgZ3JvdXAgaWQgdG8gc2VhcmNoIGZvciBncm91cHNcbiAgICogQHBhcmFtIHthcnJheX0gbGlzdCAtIHRoZSBjb250YWluZXIgZm9yIGFsbCBncm91cHNcbiAgICogQHJldHVybnMge2FycmF5fSB0aGUgY29udGFpbmVyIGZvciBhbGwgZ3JvdXBzXG4gICAqL1xuICBnZXRHcm91cHNJbkdyb3VwIChncm91cElkLCBsaXN0ID0gW10pIHtcbiAgICBjb25zdCBncm91cCA9IHRoaXMuZ2V0RW50cnkoZ3JvdXBJZCB8fCBOYU4pO1xuXG4gICAgaWYgKCFncm91cCB8fCBncm91cC50eXBlICE9PSAnZ3JvdXAnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ25vdF9hX2dyb3VwJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGdyb3VwLmNoaWxkcmVuSWRzLnJlZHVjZSgoYWNjLCBlbnRyeUlkKSA9PiB7XG4gICAgICBjb25zdCBlbnRyeSA9IHRoaXMuZ2V0RW50cnkoZW50cnlJZCk7XG4gICAgICBpZiAoZW50cnkudHlwZSA9PT0gJ2dyb3VwJykge1xuICAgICAgICBjb25zdCBzdWJMaXN0ID0gW107XG5cbiAgICAgICAgYWNjLnB1c2goe1xuICAgICAgICAgIGlkOiBlbnRyeUlkLFxuICAgICAgICAgIG5hbWU6IGVudHJ5Lm5hbWUsXG4gICAgICAgICAgZ3JvdXBzOiB0aGlzLmdldEdyb3Vwc0luR3JvdXAgKGVudHJ5SWQsIHN1Ykxpc3QpXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIGxpc3QpO1xuICB9XG5cbiAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlcXVpcmUtanNkb2MgKi9cbiAgZWRpdEVudHJ5IChpZCwgbmV3U3RhdGUpIHtcbiAgICBjb25zdCBlbnRyeSA9IHRoaXMuZ2V0RW50cnkoaWQpO1xuXG4gICAgaWYgKGVudHJ5LnBhcmVudElkICE9PSBuZXdTdGF0ZS5wYXJlbnRJZCkge1xuICAgICAgY29uc3Qgb2xkUGFyZW50ID0gdGhpcy5nZXRFbnRyeShlbnRyeS5wYXJlbnRJZCk7XG4gICAgICBjb25zdCBuZXdQYXJlbnQgPSB0aGlzLmdldEVudHJ5KG5ld1N0YXRlLnBhcmVudElkKTtcblxuICAgICAgb2xkUGFyZW50LmNoaWxkcmVuSWRzLnNwbGljZShvbGRQYXJlbnQuY2hpbGRyZW5JZHMuaW5kZXhPZihpZCksIDEpO1xuICAgICAgbmV3UGFyZW50LmNoaWxkcmVuSWRzLnB1c2goaWQpO1xuICAgIH1cblxuICAgIHRoaXMuZnVsbE9yUGFyY2lhbFVwZGF0ZUV4aXN0aW5nRW50cnkoaWQsIG5ld1N0YXRlKTtcbiAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLWNoYW5nZS1zdGF0ZScpO1xuICB9XG5cbiAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlcXVpcmUtanNkb2MgKi9cbiAgYWRkRW50cnkgKGVudHJ5KSB7XG4gICAgaWYgKCFlbnRyeSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGlkID0gdXVpZCgpO1xuXG4gICAgdGhpcy5tYXBwaW5nLnNldChpZCwgZW50cnkpO1xuICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuZ2V0RW50cnkoZW50cnkucGFyZW50SWQpO1xuXG4gICAgaWYgKHBhcmVudCkge1xuICAgICAgcGFyZW50LmNoaWxkcmVuSWRzLnB1c2goaWQpO1xuICAgIH1cblxuICAgIHRoaXMuZnVsbE9yUGFyY2lhbFVwZGF0ZUV4aXN0aW5nRW50cnkoZW50cnkucGFyZW50SWQsIHBhcmVudCk7XG5cbiAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLWNoYW5nZS1zdGF0ZScpO1xuICB9XG5cbiAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlcXVpcmUtanNkb2MgKi9cbiAgc2V0UGFyZW50T2ZFbnRyeSAoZW50cnlJZCwgcGFyZW50SWQgPSBOYU4pIHtcbiAgICBpZiAoZW50cnlJZCA9PT0gcGFyZW50SWQgfHwgZW50cnlJZCA9PT0gRE9DS19VUkkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZW50cnkgPSB0aGlzLmdldEVudHJ5KGVudHJ5SWQpO1xuXG4gICAgaWYgKCFlbnRyeSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IG9sZFBhcmVudCA9IHRoaXMuZ2V0RW50cnkoZW50cnkucGFyZW50SWQpO1xuXG4gICAgbGV0IG5ld1BhcmVudCA9IHRoaXMuZ2V0RW50cnkocGFyZW50SWQpO1xuXG4gICAgaWYgKG5ld1BhcmVudC50eXBlID09PSAncHJvamVjdCcpIHtcbiAgICAgIHBhcmVudElkID0gbmV3UGFyZW50LnBhcmVudElkO1xuICAgICAgbmV3UGFyZW50ID0gdGhpcy5nZXRFbnRyeShuZXdQYXJlbnQucGFyZW50SWQpO1xuICAgIH1cblxuICAgIG9sZFBhcmVudC5jaGlsZHJlbklkcy5zcGxpY2Uob2xkUGFyZW50LmNoaWxkcmVuSWRzLmluZGV4T2YoZW50cnlJZCksIDEpO1xuXG4gICAgbmV3UGFyZW50LmNoaWxkcmVuSWRzLnB1c2goZW50cnlJZCk7XG5cbiAgICBlbnRyeS5wYXJlbnRJZCA9IHBhcmVudElkO1xuXG4gICAgdGhpcy5mdWxsT3JQYXJjaWFsVXBkYXRlRXhpc3RpbmdFbnRyeShlbnRyeUlkLCBlbnRyeSk7XG4gICAgdGhpcy5mdWxsT3JQYXJjaWFsVXBkYXRlRXhpc3RpbmdFbnRyeShlbnRyeS5wYXJlbnRJZCwgb2xkUGFyZW50KTtcbiAgICB0aGlzLmZ1bGxPclBhcmNpYWxVcGRhdGVFeGlzdGluZ0VudHJ5KHBhcmVudElkLCBuZXdQYXJlbnQpO1xuXG4gICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1jaGFuZ2Utc3RhdGUnKTtcbiAgfVxuXG4gIC8qIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZXF1aXJlLWpzZG9jICovXG4gIGluaXRpYWxpemVTdGF0ZSAoY3VycmVudFN0YXRlKSB7XG4gICAgdGhpcy5kZXNlcmlhbGl6ZUdyb3VwQW5kUmV0dXJuSWQoY3VycmVudFN0YXRlLCB0cnVlKTtcbiAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLWNoYW5nZS1zdGF0ZScpO1xuICB9XG5cbiAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlcXVpcmUtanNkb2MgKi9cbiAgb25EaWRDaGFuZ2VTdGF0ZSAoY2IpIHtcbiAgICB0aGlzLmVtaXR0ZXIub24oJ2RpZC1jaGFuZ2Utc3RhdGUnLCBjYik7XG4gIH1cbn1cblxuLy8gc2FtZSBpbnN0YW5jZSBpcyBzaGFyZWQgYWNyb3NzIHRoZSBwYWNrYWdlXG5leHBvcnQgZGVmYXVsdCBuZXcgU3RhdGUoKTtcbiJdfQ==