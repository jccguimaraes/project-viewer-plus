Object.defineProperty(exports, "__esModule", {
  value: true
});

var _database = require('./database');

var _database2 = _interopRequireDefault(_database);

var _base = require('./../constants/base');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Class representing the Database
 */
let ContextSwitcher = class ContextSwitcher {

  /**
   * description
   *
   * @todo improve JSDoc
   */
  constructor() {
    if (ContextSwitcher.instance) {
      return ContextSwitcher.instance;
    }

    this.database = new _database2.default();
    ContextSwitcher.instance = this;
  }

  /**
   * description
   *
   * @returns {Object} description
   */
  getTreeView() {
    return atom.packages.getActivePackage('tree-view');
  }

  /**
   * description
   *
   * @returns {Object} description
   */
  saveTreeView() {
    console.log('save tree-view');
    const pkg = this.getTreeView();

    if (!pkg) {
      return {};
    }

    return pkg.mainModule.getTreeViewInstance().serialize();
  }

  /**
   * description
   *
   * @param {Object} state - description
   */
  loadTreeView(state) {
    console.log('load tree-view');
    const pkg = this.getTreeView();

    if (!pkg || !state) {
      return;
    }

    // does nothing
    pkg.mainModule.treeView = null;
    pkg.mainModule.getTreeViewInstance(state);
  }

  /**
   * description
   *
   * @returns {Object} description
   */
  getStatusBar() {
    return atom.packages.getActivePackage('status-bar');
  }

  /**
   * description
   *
   * @returns {Object} description
   */
  getLinter() {
    return atom.packages.getActivePackage('linter');
  }

  /**
   * description
   *
   * @returns {Object} description
   */
  getFindAndReplace() {
    return atom.packages.getLoadedPackage('find-and-replace');
  }

  /**
   * description
   *
   * @returns {Object} description
   */
  saveFindAndReplace() {
    console.log('save find-and-replace');
    const pkg = this.getFindAndReplace();

    if (!pkg) {
      return;
    }

    return pkg.serialize();
  }

  /**
   * description
   *
   * @param {Object} state - description
   */
  loadFindAndReplace(state) {
    console.log('load find-and-replace');
    const pkg = this.getFindAndReplace();

    if (!pkg || !pkg.mainActivated || !state) {
      return;
    }

    pkg.mainModule.findHistory.items = state.findHistory;
    pkg.mainModule.findHistory.length = state.findHistory.length;

    pkg.mainModule.findOptions.caseSensitive = state.findOptions.caseSensitive;
    pkg.mainModule.findOptions.findPattern = state.findOptions.findPattern;
    pkg.mainModule.findOptions.inCurrentSelection = state.findOptions.inCurrentSelection;
    pkg.mainModule.findOptions.leadingContextLineCount = state.findOptions.leadingContextLineCount;
    pkg.mainModule.findOptions.pathsPattern = state.findOptions.pathsPattern;
    pkg.mainModule.findOptions.replacePattern = state.findOptions.replacePattern;
    pkg.mainModule.findOptions.trailingContextLineCount = state.findOptions.trailingContextLineCount;
    pkg.mainModule.findOptions.useRegex = state.findOptions.useRegex;
    pkg.mainModule.findOptions.wholeWord = state.findOptions.wholeWord;

    pkg.mainModule.pathsHistory.items = state.pathsHistory;
    pkg.mainModule.pathsHistory.length = state.pathsHistory.length;

    pkg.mainModule.replaceHistory.items = state.replaceHistory;
    pkg.mainModule.replaceHistory.length = state.replaceHistory.length;
  }

  /**
   * description
   *
   * @param {Object} states - description
   */
  saveOtherPackages(states) {
    // tree-view is not serialized into workspace.packageStates
    states['tree-view'] = this.saveTreeView();
    states['find-and-replace'] = this.saveFindAndReplace();
  }

  /**
   * description
   *
   * @param {Object} states - description
   */
  loadOtherPackages(states) {
    this.loadTreeView(states['tree-view']);
    this.loadFindAndReplace(states['find-and-replace']);
  }

  /**
   * description
   *
   * @param {Object} project - description
   * @returns {Promise} description
   */
  saveContext(project) {
    const context = {
      current_project: null,
      next_project: project,
      key: null,
      state: null
    };

    if (this.database.content.selectedId) {
      context.current_project = this.database.content.map[this.database.content.selectedId];
      console.log('try to save context for', context.current_project);
    } else {
      context.current_project = { model: { paths: atom.project.getPaths() } };
      console.log('try to save context for first time', context.current_project);
    }

    // validate if same projects (paths) - tip: use atom.getStateKey

    context.key = atom.getStateKey(context.current_project.model.paths);
    context.state = atom.serialize();
    context.state.extraStates = {};

    this.saveOtherPackages(context.state.extraStates);

    if (context.key && context.state) {
      atom.getStorageFolder().storeSync(context.key, context.state);
    }

    return Promise.resolve(context);
  }

  /**
   * description
   *
   * @param {Object} context - description
   * @returns {Promise} description
   */
  loadContext(context) {
    console.log('load', context.next_project);

    if (context.next_project.type !== 'project') {
      return Promise.reject(_base.MESSAGES.CONTEXT.NOT_A_PROJECT);
    }
    if (!this.database.content.ids.includes(context.next_project.id)) {
      return Promise.reject(_base.MESSAGES.CONTEXT.NO_VALID_PROJECT_ID);
    }

    context.key = atom.getStateKey(context.next_project.model.paths);
    context.state = atom.getStorageFolder().load(context.key);

    if (!context.state) {
      atom.project.setPaths(context.next_project.model.paths);
      atom.workspace.getCenter().paneContainer.activePane.destroy();

      this.database.content.selectedId = context.next_project.id;

      context.current_project.selected = false;
      context.next_project.selected = true;

      this.database.update();
      return Promise.resolve(context);
    }

    // this must run only if context is to be kept in same instance
    context.state.workspace.paneContainers.bottom.paneContainer = {};
    context.state.workspace.paneContainers.left.paneContainer = {};
    context.state.workspace.paneContainers.center.paneContainer = {};
    context.state.workspace.paneContainers.right.paneContainer = {};

    return atom.deserialize(context.state).then(() => {
      // reload / update / whatever Other packages
      this.loadOtherPackages(context.state.extraStates);

      this.getStatusBar().mainModule.fileInfo.update();
      this.getStatusBar().mainModule.gitInfo.update();

      this.database.content.selectedId = context.next_project.id;

      // needs a better mechanism because collapsing a group will erase then
      // selected project
      context.current_project.selected = false;
      context.next_project.selected = true;

      this.database.update();
    });
  }

  /**
   * description
   *
   * @param {Object} project - description
   * @returns {Promise} description
   */
  switchContext(project) {
    return this.saveContext(project).then(context => this.loadContext(context)).catch(reason => console.log(reason));
  }
};
exports.default = ContextSwitcher;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9zZXJ2aWNlcy9jb250ZXh0LXN3aXRjaGVyLmpzIl0sIm5hbWVzIjpbIkNvbnRleHRTd2l0Y2hlciIsImNvbnN0cnVjdG9yIiwiaW5zdGFuY2UiLCJkYXRhYmFzZSIsImdldFRyZWVWaWV3IiwiYXRvbSIsInBhY2thZ2VzIiwiZ2V0QWN0aXZlUGFja2FnZSIsInNhdmVUcmVlVmlldyIsImNvbnNvbGUiLCJsb2ciLCJwa2ciLCJtYWluTW9kdWxlIiwiZ2V0VHJlZVZpZXdJbnN0YW5jZSIsInNlcmlhbGl6ZSIsImxvYWRUcmVlVmlldyIsInN0YXRlIiwidHJlZVZpZXciLCJnZXRTdGF0dXNCYXIiLCJnZXRMaW50ZXIiLCJnZXRGaW5kQW5kUmVwbGFjZSIsImdldExvYWRlZFBhY2thZ2UiLCJzYXZlRmluZEFuZFJlcGxhY2UiLCJsb2FkRmluZEFuZFJlcGxhY2UiLCJtYWluQWN0aXZhdGVkIiwiZmluZEhpc3RvcnkiLCJpdGVtcyIsImxlbmd0aCIsImZpbmRPcHRpb25zIiwiY2FzZVNlbnNpdGl2ZSIsImZpbmRQYXR0ZXJuIiwiaW5DdXJyZW50U2VsZWN0aW9uIiwibGVhZGluZ0NvbnRleHRMaW5lQ291bnQiLCJwYXRoc1BhdHRlcm4iLCJyZXBsYWNlUGF0dGVybiIsInRyYWlsaW5nQ29udGV4dExpbmVDb3VudCIsInVzZVJlZ2V4Iiwid2hvbGVXb3JkIiwicGF0aHNIaXN0b3J5IiwicmVwbGFjZUhpc3RvcnkiLCJzYXZlT3RoZXJQYWNrYWdlcyIsInN0YXRlcyIsImxvYWRPdGhlclBhY2thZ2VzIiwic2F2ZUNvbnRleHQiLCJwcm9qZWN0IiwiY29udGV4dCIsImN1cnJlbnRfcHJvamVjdCIsIm5leHRfcHJvamVjdCIsImtleSIsImNvbnRlbnQiLCJzZWxlY3RlZElkIiwibWFwIiwibW9kZWwiLCJwYXRocyIsImdldFBhdGhzIiwiZ2V0U3RhdGVLZXkiLCJleHRyYVN0YXRlcyIsImdldFN0b3JhZ2VGb2xkZXIiLCJzdG9yZVN5bmMiLCJQcm9taXNlIiwicmVzb2x2ZSIsImxvYWRDb250ZXh0IiwidHlwZSIsInJlamVjdCIsIkNPTlRFWFQiLCJOT1RfQV9QUk9KRUNUIiwiaWRzIiwiaW5jbHVkZXMiLCJpZCIsIk5PX1ZBTElEX1BST0pFQ1RfSUQiLCJsb2FkIiwic2V0UGF0aHMiLCJ3b3Jrc3BhY2UiLCJnZXRDZW50ZXIiLCJwYW5lQ29udGFpbmVyIiwiYWN0aXZlUGFuZSIsImRlc3Ryb3kiLCJzZWxlY3RlZCIsInVwZGF0ZSIsInBhbmVDb250YWluZXJzIiwiYm90dG9tIiwibGVmdCIsImNlbnRlciIsInJpZ2h0IiwiZGVzZXJpYWxpemUiLCJ0aGVuIiwiZmlsZUluZm8iLCJnaXRJbmZvIiwic3dpdGNoQ29udGV4dCIsImNhdGNoIiwicmVhc29uIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUE7Ozs7QUFDQTs7OztBQUVBOzs7SUFHTUEsZSxHQUFOLE1BQU1BLGVBQU4sQ0FBc0I7O0FBSXBCOzs7OztBQUtBQyxnQkFBZTtBQUNiLFFBQUlELGdCQUFnQkUsUUFBcEIsRUFBOEI7QUFDNUIsYUFBT0YsZ0JBQWdCRSxRQUF2QjtBQUNEOztBQUVELFNBQUtDLFFBQUwsR0FBZ0Isd0JBQWhCO0FBQ0FILG9CQUFnQkUsUUFBaEIsR0FBMkIsSUFBM0I7QUFDRDs7QUFFRDs7Ozs7QUFLQUUsZ0JBQWU7QUFDYixXQUFPQyxLQUFLQyxRQUFMLENBQWNDLGdCQUFkLENBQStCLFdBQS9CLENBQVA7QUFDRDs7QUFFRDs7Ozs7QUFLQUMsaUJBQWdCO0FBQ2RDLFlBQVFDLEdBQVIsQ0FBWSxnQkFBWjtBQUNBLFVBQU1DLE1BQU0sS0FBS1AsV0FBTCxFQUFaOztBQUVBLFFBQUksQ0FBQ08sR0FBTCxFQUFVO0FBQ1IsYUFBTyxFQUFQO0FBQ0Q7O0FBRUQsV0FBT0EsSUFBSUMsVUFBSixDQUFlQyxtQkFBZixHQUFxQ0MsU0FBckMsRUFBUDtBQUNEOztBQUVEOzs7OztBQUtBQyxlQUFjQyxLQUFkLEVBQXFCO0FBQ25CUCxZQUFRQyxHQUFSLENBQVksZ0JBQVo7QUFDQSxVQUFN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QUFLM0UsUUFBTCxDQUFjOEMsT0FBZCxDQUFzQkMsVUFBdEIsR0FBbUNMLFFBQVFFLFlBQVIsQ0FBcUJxQixFQUF4RDs7QUFFQTtBQUNBO0FBQ0F2QixjQUFRQyxlQUFSLENBQXdCK0IsUUFBeEIsR0FBbUMsS0FBbkM7QUFDQWhDLGNBQVFFLFlBQVIsQ0FBcUI4QixRQUFyQixHQUFnQyxJQUFoQzs7QUFFQSxXQUFLMUUsUUFBTCxDQUFjMkUsTUFBZDtBQUNELEtBaEJJLENBQVA7QUFpQkQ7O0FBRUQ7Ozs7OztBQU1BVSxnQkFBZTVDLE9BQWYsRUFBd0I7QUFDdEIsV0FBTyxLQUFLRCxXQUFMLENBQWlCQyxPQUFqQixFQUNKeUMsSUFESSxDQUNDeEMsV0FBVyxLQUFLZ0IsV0FBTCxDQUFpQmhCLE9BQWpCLENBRFosRUFFSjRDLEtBRkksQ0FFRUMsVUFBVWpGLFFBQVFDLEdBQVIsQ0FBWWdGLE1BQVosQ0FGWixDQUFQO0FBR0Q7QUFwUm1CLEM7a0JBdVJQMUYsZSIsImZpbGUiOiJjb250ZXh0LXN3aXRjaGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IERhdGFiYXNlIGZyb20gJy4vZGF0YWJhc2UnO1xuaW1wb3J0IHsgTUVTU0FHRVMgfSBmcm9tICcuLy4uL2NvbnN0YW50cy9iYXNlJztcblxuLyoqXG4gKiBDbGFzcyByZXByZXNlbnRpbmcgdGhlIERhdGFiYXNlXG4gKi9cbmNsYXNzIENvbnRleHRTd2l0Y2hlciB7XG5cbiAgc3RhdGljIGluc3RhbmNlO1xuXG4gIC8qKlxuICAgKiBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBAdG9kbyBpbXByb3ZlIEpTRG9jXG4gICAqL1xuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgaWYgKENvbnRleHRTd2l0Y2hlci5pbnN0YW5jZSkge1xuICAgICAgcmV0dXJuIENvbnRleHRTd2l0Y2hlci5pbnN0YW5jZTtcbiAgICB9XG5cbiAgICB0aGlzLmRhdGFiYXNlID0gbmV3IERhdGFiYXNlKCk7XG4gICAgQ29udGV4dFN3aXRjaGVyLmluc3RhbmNlID0gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBAcmV0dXJucyB7T2JqZWN0fSBkZXNjcmlwdGlvblxuICAgKi9cbiAgZ2V0VHJlZVZpZXcgKCkge1xuICAgIHJldHVybiBhdG9tLnBhY2thZ2VzLmdldEFjdGl2ZVBhY2thZ2UoJ3RyZWUtdmlldycpO1xuICB9XG5cbiAgLyoqXG4gICAqIGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIEByZXR1cm5zIHtPYmplY3R9IGRlc2NyaXB0aW9uXG4gICAqL1xuICBzYXZlVHJlZVZpZXcgKCkge1xuICAgIGNvbnNvbGUubG9nKCdzYXZlIHRyZWUtdmlldycpO1xuICAgIGNvbnN0IHBrZyA9IHRoaXMuZ2V0VHJlZVZpZXcoKTtcblxuICAgIGlmICghcGtnKSB7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuXG4gICAgcmV0dXJuIHBrZy5tYWluTW9kdWxlLmdldFRyZWVWaWV3SW5zdGFuY2UoKS5zZXJpYWxpemUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gc3RhdGUgLSBkZXNjcmlwdGlvblxuICAgKi9cbiAgbG9hZFRyZWVWaWV3IChzdGF0ZSkge1xuICAgIGNvbnNvbGUubG9nKCdsb2FkIHRyZWUtdmlldycpO1xuICAgIGNvbnN0IHBrZyA9IHRoaXMuZ2V0VHJlZVZpZXcoKTtcblxuICAgIGlmICghcGtnIHx8ICFzdGF0ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGRvZXMgbm90aGluZ1xuICAgIHBrZy5tYWluTW9kdWxlLnRyZWVWaWV3ID0gbnVsbDtcbiAgICBwa2cubWFpbk1vZHVsZS5nZXRUcmVlVmlld0luc3RhbmNlKHN0YXRlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBAcmV0dXJucyB7T2JqZWN0fSBkZXNjcmlwdGlvblxuICAgKi9cbiAgZ2V0U3RhdHVzQmFyICgpIHtcbiAgICByZXR1cm4gYXRvbS5wYWNrYWdlcy5nZXRBY3RpdmVQYWNrYWdlKCdzdGF0dXMtYmFyJyk7XG4gIH1cblxuICAvKipcbiAgICogZGVzY3JpcHRpb25cbiAgICpcbiAgICogQHJldHVybnMge09iamVjdH0gZGVzY3JpcHRpb25cbiAgICovXG4gIGdldExpbnRlciAoKSB7XG4gICAgcmV0dXJuIGF0b20ucGFja2FnZXMuZ2V0QWN0aXZlUGFja2FnZSgnbGludGVyJyk7XG4gIH1cblxuICAvKipcbiAgICogZGVzY3JpcHRpb25cbiAgICpcbiAgICogQHJldHVybnMge09iamVjdH0gZGVzY3JpcHRpb25cbiAgICovXG4gIGdldEZpbmRBbmRSZXBsYWNlICgpIHtcbiAgICByZXR1cm4gYXRvbS5wYWNrYWdlcy5nZXRMb2FkZWRQYWNrYWdlKCdmaW5kLWFuZC1yZXBsYWNlJyk7XG4gIH1cblxuICAvKipcbiAgICogZGVzY3JpcHRpb25cbiAgICpcbiAgICogQHJldHVybnMge09iamVjdH0gZGVzY3JpcHRpb25cbiAgICovXG4gIHNhdmVGaW5kQW5kUmVwbGFjZSAoKSB7XG4gICAgY29uc29sZS5sb2coJ3NhdmUgZmluZC1hbmQtcmVwbGFjZScpO1xuICAgIGNvbnN0IHBrZyA9IHRoaXMuZ2V0RmluZEFuZFJlcGxhY2UoKTtcblxuICAgIGlmICghcGtnKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcmV0dXJuIHBrZy5zZXJpYWxpemUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gc3RhdGUgLSBkZXNjcmlwdGlvblxuICAgKi9cbiAgbG9hZEZpbmRBbmRSZXBsYWNlIChzdGF0ZSkge1xuICAgIGNvbnNvbGUubG9nKCdsb2FkIGZpbmQtYW5kLXJlcGxhY2UnKTtcbiAgICBjb25zdCBwa2cgPSB0aGlzLmdldEZpbmRBbmRSZXBsYWNlKCk7XG5cbiAgICBpZiAoIXBrZyB8fCAhcGtnLm1haW5BY3RpdmF0ZWQgfHwgIXN0YXRlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcGtnLm1haW5Nb2R1bGUuZmluZEhpc3RvcnkuaXRlbXMgPSBzdGF0ZS5maW5kSGlzdG9yeTtcbiAgICBwa2cubWFpbk1vZHVsZS5maW5kSGlzdG9yeS5sZW5ndGggPSBzdGF0ZS5maW5kSGlzdG9yeS5sZW5ndGg7XG5cbiAgICBwa2cubWFpbk1vZHVsZS5maW5kT3B0aW9uc1xuICAgICAgLmNhc2VTZW5zaXRpdmUgPSBzdGF0ZS5maW5kT3B0aW9ucy5jYXNlU2Vuc2l0aXZlO1xuICAgIHBrZy5tYWluTW9kdWxlLmZpbmRPcHRpb25zXG4gICAgICAuZmluZFBhdHRlcm4gPSBzdGF0ZS5maW5kT3B0aW9ucy5maW5kUGF0dGVybjtcbiAgICBwa2cubWFpbk1vZHVsZS5maW5kT3B0aW9uc1xuICAgICAgLmluQ3VycmVudFNlbGVjdGlvbiA9IHN0YXRlLmZpbmRPcHRpb25zLmluQ3VycmVudFNlbGVjdGlvbjtcbiAgICBwa2cubWFpbk1vZHVsZS5maW5kT3B0aW9uc1xuICAgICAgLmxlYWRpbmdDb250ZXh0TGluZUNvdW50ID0gc3RhdGUuZmluZE9wdGlvbnMubGVhZGluZ0NvbnRleHRMaW5lQ291bnQ7XG4gICAgcGtnLm1haW5Nb2R1bGUuZmluZE9wdGlvbnNcbiAgICAgIC5wYXRoc1BhdHRlcm4gPSBzdGF0ZS5maW5kT3B0aW9ucy5wYXRoc1BhdHRlcm47XG4gICAgcGtnLm1haW5Nb2R1bGUuZmluZE9wdGlvbnNcbiAgICAgIC5yZXBsYWNlUGF0dGVybiA9IHN0YXRlLmZpbmRPcHRpb25zLnJlcGxhY2VQYXR0ZXJuO1xuICAgIHBrZy5tYWluTW9kdWxlLmZpbmRPcHRpb25zXG4gICAgICAudHJhaWxpbmdDb250ZXh0TGluZUNvdW50ID0gc3RhdGUuZmluZE9wdGlvbnMudHJhaWxpbmdDb250ZXh0TGluZUNvdW50O1xuICAgIHBrZy5tYWluTW9kdWxlLmZpbmRPcHRpb25zXG4gICAgICAudXNlUmVnZXggPSBzdGF0ZS5maW5kT3B0aW9ucy51c2VSZWdleDtcbiAgICBwa2cubWFpbk1vZHVsZS5maW5kT3B0aW9uc1xuICAgICAgLndob2xlV29yZCA9IHN0YXRlLmZpbmRPcHRpb25zLndob2xlV29yZDtcblxuICAgIHBrZy5tYWluTW9kdWxlLnBhdGhzSGlzdG9yeS5pdGVtcyA9IHN0YXRlLnBhdGhzSGlzdG9yeTtcbiAgICBwa2cubWFpbk1vZHVsZS5wYXRoc0hpc3RvcnkubGVuZ3RoID0gc3RhdGUucGF0aHNIaXN0b3J5Lmxlbmd0aDtcblxuICAgIHBrZy5tYWluTW9kdWxlLnJlcGxhY2VIaXN0b3J5Lml0ZW1zID0gc3RhdGUucmVwbGFjZUhpc3Rvcnk7XG4gICAgcGtnLm1haW5Nb2R1bGUucmVwbGFjZUhpc3RvcnkubGVuZ3RoID0gc3RhdGUucmVwbGFjZUhpc3RvcnkubGVuZ3RoO1xuICB9XG5cbiAgLyoqXG4gICAqIGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBzdGF0ZXMgLSBkZXNjcmlwdGlvblxuICAgKi9cbiAgc2F2ZU90aGVyUGFja2FnZXMgKHN0YXRlcykge1xuICAgIC8vIHRyZWUtdmlldyBpcyBub3Qgc2VyaWFsaXplZCBpbnRvIHdvcmtzcGFjZS5wYWNrYWdlU3RhdGVzXG4gICAgc3RhdGVzWyd0cmVlLXZpZXcnXSA9IHRoaXMuc2F2ZVRyZWVWaWV3KCk7XG4gICAgc3RhdGVzWydmaW5kLWFuZC1yZXBsYWNlJ10gPSB0aGlzLnNhdmVGaW5kQW5kUmVwbGFjZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBzdGF0ZXMgLSBkZXNjcmlwdGlvblxuICAgKi9cbiAgbG9hZE90aGVyUGFja2FnZXMgKHN0YXRlcykge1xuICAgIHRoaXMubG9hZFRyZWVWaWV3KHN0YXRlc1sndHJlZS12aWV3J10pO1xuICAgIHRoaXMubG9hZEZpbmRBbmRSZXBsYWNlKHN0YXRlc1snZmluZC1hbmQtcmVwbGFjZSddKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gcHJvamVjdCAtIGRlc2NyaXB0aW9uXG4gICAqIEByZXR1cm5zIHtQcm9taXNlfSBkZXNjcmlwdGlvblxuICAgKi9cbiAgc2F2ZUNvbnRleHQgKHByb2plY3QpIHtcbiAgICBjb25zdCBjb250ZXh0ID0ge1xuICAgICAgY3VycmVudF9wcm9qZWN0OiBudWxsLFxuICAgICAgbmV4dF9wcm9qZWN0OiBwcm9qZWN0LFxuICAgICAga2V5OiBudWxsLFxuICAgICAgc3RhdGU6IG51bGxcbiAgICB9O1xuXG4gICAgaWYgKHRoaXMuZGF0YWJhc2UuY29udGVudC5zZWxlY3RlZElkKSB7XG4gICAgICBjb250ZXh0LmN1cnJlbnRfcHJvamVjdCA9IHRoaXMuZGF0YWJhc2UuY29udGVudC5tYXBbXG4gICAgICAgIHRoaXMuZGF0YWJhc2UuY29udGVudC5zZWxlY3RlZElkXG4gICAgICBdO1xuICAgICAgY29uc29sZS5sb2coJ3RyeSB0byBzYXZlIGNvbnRleHQgZm9yJywgY29udGV4dC5jdXJyZW50X3Byb2plY3QpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGNvbnRleHQuY3VycmVudF9wcm9qZWN0ID0geyBtb2RlbDogeyBwYXRoczogYXRvbS5wcm9qZWN0LmdldFBhdGhzKCkgfSB9O1xuICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICd0cnkgdG8gc2F2ZSBjb250ZXh0IGZvciBmaXJzdCB0aW1lJywgY29udGV4dC5jdXJyZW50X3Byb2plY3RcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gdmFsaWRhdGUgaWYgc2FtZSBwcm9qZWN0cyAocGF0aHMpIC0gdGlwOiB1c2UgYXRvbS5nZXRTdGF0ZUtleVxuXG4gICAgY29udGV4dC5rZXkgPSBhdG9tLmdldFN0YXRlS2V5KGNvbnRleHQuY3VycmVudF9wcm9qZWN0Lm1vZGVsLnBhdGhzKTtcbiAgICBjb250ZXh0LnN0YXRlID0gYXRvbS5zZXJpYWxpemUoKTtcbiAgICBjb250ZXh0LnN0YXRlLmV4dHJhU3RhdGVzID0ge307XG5cbiAgICB0aGlzLnNhdmVPdGhlclBhY2thZ2VzKGNvbnRleHQuc3RhdGUuZXh0cmFTdGF0ZXMpO1xuXG4gICAgaWYgKGNvbnRleHQua2V5ICYmIGNvbnRleHQuc3RhdGUpIHtcbiAgICAgIGF0b20uZ2V0U3RvcmFnZUZvbGRlcigpLnN0b3JlU3luYyhjb250ZXh0LmtleSwgY29udGV4dC5zdGF0ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShjb250ZXh0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gY29udGV4dCAtIGRlc2NyaXB0aW9uXG4gICAqIEByZXR1cm5zIHtQcm9taXNlfSBkZXNjcmlwdGlvblxuICAgKi9cbiAgbG9hZENvbnRleHQgKGNvbnRleHQpIHtcbiAgICBjb25zb2xlLmxvZygnbG9hZCcsIGNvbnRleHQubmV4dF9wcm9qZWN0KTtcblxuICAgIGlmIChjb250ZXh0Lm5leHRfcHJvamVjdC50eXBlICE9PSAncHJvamVjdCcpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChNRVNTQUdFUy5DT05URVhULk5PVF9BX1BST0pFQ1QpO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuZGF0YWJhc2UuY29udGVudC5pZHMuaW5jbHVkZXMoY29udGV4dC5uZXh0X3Byb2plY3QuaWQpKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoTUVTU0FHRVMuQ09OVEVYVC5OT19WQUxJRF9QUk9KRUNUX0lEKTtcbiAgICB9XG5cbiAgICBjb250ZXh0LmtleSA9IGF0b20uZ2V0U3RhdGVLZXkoY29udGV4dC5uZXh0X3Byb2plY3QubW9kZWwucGF0aHMpO1xuICAgIGNvbnRleHQuc3RhdGUgPSBhdG9tLmdldFN0b3JhZ2VGb2xkZXIoKS5sb2FkKGNvbnRleHQua2V5KTtcblxuICAgIGlmICghY29udGV4dC5zdGF0ZSkge1xuICAgICAgYXRvbS5wcm9qZWN0LnNldFBhdGhzKGNvbnRleHQubmV4dF9wcm9qZWN0Lm1vZGVsLnBhdGhzKTtcbiAgICAgIGF0b20ud29ya3NwYWNlLmdldENlbnRlcigpLnBhbmVDb250YWluZXIuYWN0aXZlUGFuZS5kZXN0cm95KCk7XG5cbiAgICAgIHRoaXMuZGF0YWJhc2UuY29udGVudC5zZWxlY3RlZElkID0gY29udGV4dC5uZXh0X3Byb2plY3QuaWQ7XG5cbiAgICAgIGNvbnRleHQuY3VycmVudF9wcm9qZWN0LnNlbGVjdGVkID0gZmFsc2U7XG4gICAgICBjb250ZXh0Lm5leHRfcHJvamVjdC5zZWxlY3RlZCA9IHRydWU7XG5cbiAgICAgIHRoaXMuZGF0YWJhc2UudXBkYXRlKCk7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNvbnRleHQpO1xuICAgIH1cblxuICAgIC8vIHRoaXMgbXVzdCBydW4gb25seSBpZiBjb250ZXh0IGlzIHRvIGJlIGtlcHQgaW4gc2FtZSBpbnN0YW5jZVxuICAgIGNvbnRleHQuc3RhdGUud29ya3NwYWNlLnBhbmVDb250YWluZXJzLmJvdHRvbS5wYW5lQ29udGFpbmVyID0ge307XG4gICAgY29udGV4dC5zdGF0ZS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lcnMubGVmdC5wYW5lQ29udGFpbmVyID0ge307XG4gICAgY29udGV4dC5zdGF0ZS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lcnMuY2VudGVyLnBhbmVDb250YWluZXIgPSB7fTtcbiAgICBjb250ZXh0LnN0YXRlLndvcmtzcGFjZS5wYW5lQ29udGFpbmVycy5yaWdodC5wYW5lQ29udGFpbmVyID0ge307XG5cbiAgICByZXR1cm4gYXRvbS5kZXNlcmlhbGl6ZShjb250ZXh0LnN0YXRlKVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAvLyByZWxvYWQgLyB1cGRhdGUgLyB3aGF0ZXZlciBPdGhlciBwYWNrYWdlc1xuICAgICAgICB0aGlzLmxvYWRPdGhlclBhY2thZ2VzKGNvbnRleHQuc3RhdGUuZXh0cmFTdGF0ZXMpO1xuXG4gICAgICAgIHRoaXMuZ2V0U3RhdHVzQmFyKCkubWFpbk1vZHVsZS5maWxlSW5mby51cGRhdGUoKTtcbiAgICAgICAgdGhpcy5nZXRTdGF0dXNCYXIoKS5tYWluTW9kdWxlLmdpdEluZm8udXBkYXRlKCk7XG5cbiAgICAgICAgdGhpcy5kYXRhYmFzZS5jb250ZW50LnNlbGVjdGVkSWQgPSBjb250ZXh0Lm5leHRfcHJvamVjdC5pZDtcblxuICAgICAgICAvLyBuZWVkcyBhIGJldHRlciBtZWNoYW5pc20gYmVjYXVzZSBjb2xsYXBzaW5nIGEgZ3JvdXAgd2lsbCBlcmFzZSB0aGVuXG4gICAgICAgIC8vIHNlbGVjdGVkIHByb2plY3RcbiAgICAgICAgY29udGV4dC5jdXJyZW50X3Byb2plY3Quc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgY29udGV4dC5uZXh0X3Byb2plY3Quc2VsZWN0ZWQgPSB0cnVlO1xuXG4gICAgICAgIHRoaXMuZGF0YWJhc2UudXBkYXRlKCk7XG4gICAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gcHJvamVjdCAtIGRlc2NyaXB0aW9uXG4gICAqIEByZXR1cm5zIHtQcm9taXNlfSBkZXNjcmlwdGlvblxuICAgKi9cbiAgc3dpdGNoQ29udGV4dCAocHJvamVjdCkge1xuICAgIHJldHVybiB0aGlzLnNhdmVDb250ZXh0KHByb2plY3QpXG4gICAgICAudGhlbihjb250ZXh0ID0+IHRoaXMubG9hZENvbnRleHQoY29udGV4dCkpXG4gICAgICAuY2F0Y2gocmVhc29uID0+IGNvbnNvbGUubG9nKHJlYXNvbikpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IENvbnRleHRTd2l0Y2hlcjtcbiJdfQ==