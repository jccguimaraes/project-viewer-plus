Object.defineProperty(exports, "__esModule", {
  value: true
});

var _devlog = require('./devlog');

var _devlog2 = _interopRequireDefault(_devlog);

var _database = require('./database');

var _database2 = _interopRequireDefault(_database);

var _packages = require('./packages');

var _packages2 = _interopRequireDefault(_packages);

var _base = require('./../constants/base');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Class representing the Database
 */
let ContextSwitcher = class ContextSwitcher {

  /**
   * description
   *
   * @todo improve JSDoc
   */
  constructor() {
    if (ContextSwitcher.instance) {
      return ContextSwitcher.instance;
    }
    ContextSwitcher.instance = this;

    this.database = new _database2.default();
    this.packages = new _packages2.default();
  }

  /**
   * description
   *
   * @param {Object} states - description
   */
  savePackages(states) {
    states['tree-view'] = this.packages.treeView.save();
    states['find-and-replace'] = this.packages.findAndReplace.save();
    this.packages.statusBar.save(); // TODO: remove as it does nothing
    this.packages.linterUIDefault.save(); // TODO: remove as it does nothing
    this.packages.linter.save(); // TODO: remove as it does nothing
  }

  /**
   * description
   *
   * @param {Object} states - description
   * @returns {Promise} description
   */
  loadPackages(states) {
    return this.packages.treeView.load(states['tree-view']).then(() => this.packages.findAndReplace.load(states['find-and-replace'])).then(() => this.packages.statusBar.load()).then(() => this.packages.linter.load()).then(() => this.packages.linterUIDefault.load());
  }

  /**
   * description
   *
   * @param {Object} project - description
   * @returns {Promise} description
   */
  saveContext(project) {
    return new Promise(resolve => {
      const context = {
        current_project: null,
        next_project: project,
        key: null,
        state: null
      };

      context.current_project = this.database.content.selectedId ? this.database.content.map[this.database.content.selectedId] : { model: { paths: atom.project.getPaths() } };

      (0, _devlog2.default)('save context', context.current_project);

      // validate if same projects (paths) - tip: use atom.getStateKey

      context.key = atom.getStateKey(context.current_project.model.paths);
      context.state = atom.serialize();
      context.state.extraStates = {};

      if (context.key && context.state) {
        this.savePackages(context.state.extraStates);
        atom.getStorageFolder().storeSync(context.key, context.state);
      }

      resolve(context);
    });
  }

  /**
   * description
   *
   * @param {Object} context - description
   * @returns {Promise} description
   */
  loadContext(context) {
    return new Promise((resolve, reject) => {
      (0, _devlog2.default)('load context', context.next_project);

      if (context.next_project.type !== 'project') {
        return reject(_base.MESSAGES.CONTEXT.NOT_A_PROJECT);
      }
      if (!this.database.content.ids.includes(context.next_project.id)) {
        return reject(_base.MESSAGES.CONTEXT.NO_VALID_PROJECT_ID);
      }

      context.key = atom.getStateKey(context.next_project.model.paths);
      context.state = atom.getStorageFolder().load(context.key);

      if (!context.state || atom.getStateKey(context.state.project.paths) !== context.key) {
        atom.project.setPaths(context.next_project.model.paths);
        atom.workspace.getCenter().paneContainer.activePane.destroy();

        this.database.content.selectedId = context.next_project.id;

        context.current_project.selected = false;
        context.next_project.selected = true;

        return resolve(context);
      }

      // this must run only if context is to be kept in same instance
      context.state.workspace.paneContainers.left.paneContainer = {};
      context.state.workspace.paneContainers.right.paneContainer = {};

      atom.deserialize(context.state).then(() => this.loadPackages(context.state.extraStates)).then(() => {
        this.database.content.selectedId = context.next_project.id;

        // TODO: needs a better mechanism because collapsing a group
        // will erase the selected project
        context.current_project.selected = false;
        context.next_project.selected = true;

        // TODO: this is bad for performance
        this.database.update();

        resolve(context);
      });
    });
  }

  /**
   * description
   *
   * @param {Object} project - description
   * @returns {Promise} description
   */
  switchContext(project) {
    return this.saveContext(project).then(context => this.loadContext(context)).catch(reason => (0, _devlog2.default)(reason));
  }
};
exports.default = ContextSwitcher;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9zZXJ2aWNlcy9jb250ZXh0LXN3aXRjaGVyLmpzIl0sIm5hbWVzIjpbIkNvbnRleHRTd2l0Y2hlciIsImNvbnN0cnVjdG9yIiwiaW5zdGFuY2UiLCJkYXRhYmFzZSIsInBhY2thZ2VzIiwic2F2ZVBhY2thZ2VzIiwic3RhdGVzIiwidHJlZVZpZXciLCJzYXZlIiwiZmluZEFuZFJlcGxhY2UiLCJzdGF0dXNCYXIiLCJsaW50ZXJVSURlZmF1bHQiLCJsaW50ZXIiLCJsb2FkUGFja2FnZXMiLCJsb2FkIiwidGhlbiIsInNhdmVDb250ZXh0IiwicHJvamVjdCIsIlByb21pc2UiLCJyZXNvbHZlIiwiY29udGV4dCIsImN1cnJlbnRfcHJvamVjdCIsIm5leHRfcHJvamVjdCIsImtleSIsInN0YXRlIiwiY29udGVudCIsInNlbGVjdGVkSWQiLCJtYXAiLCJtb2RlbCIsInBhdGhzIiwiYXRvbSIsImdldFBhdGhzIiwiZ2V0U3RhdGVLZXkiLCJzZXJpYWxpemUiLCJleHRyYVN0YXRlcyIsImdldFN0b3JhZ2VGb2xkZXIiLCJzdG9yZVN5bmMiLCJsb2FkQ29udGV4dCIsInJlamVjdCIsInR5cGUiLCJDT05URVhUIiwiTk9UX0FfUFJPSkVDVCIsImlkcyIsImluY2x1ZGVzIiwiaWQiLCJOT19WQUxJRF9QUk9KRUNUX0lEIiwic2V0UGF0aHMiLCJ3b3Jrc3BhY2UiLCJnZXRDZW50ZXIiLCJwYW5lQ29udGFpbmVyIiwiYWN0aXZlUGFuZSIsImRlc3Ryb3kiLCJzZWxlY3RlZCIsInBhbmVDb250YWluZXJzIiwibGVmdCIsInJpZ2h0IiwiZGVzZXJpYWxpemUiLCJ1cGRhdGUiLCJzd2l0Y2hDb250ZXh0IiwiY2F0Y2giLCJyZWFzb24iXSwibWFwcGluZ3MiOiI7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7SUFHTUEsZSxHQUFOLE1BQU1BLGVBQU4sQ0FBc0I7O0FBSXBCOzs7OztBQUtBQyxnQkFBZTtBQUNiLFFBQUlELGdCQUFn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QXVDQyxJQUF2QyxDQUE0Q0wsYUFBNUMsR0FBNEQsRUFBNUQ7QUFDQTdCLGNBQVFJLEtBQVIsQ0FBY3VCLFNBQWQsQ0FBd0JNLGNBQXhCLENBQXVDRSxLQUF2QyxDQUE2Q04sYUFBN0MsR0FBNkQsRUFBN0Q7O0FBRUFuQixXQUFLMEIsV0FBTCxDQUFpQnBDLFFBQVFJLEtBQXpCLEVBQ0dULElBREgsQ0FDUSxNQUFNLEtBQUtGLFlBQUwsQ0FBa0JPLFFBQVFJLEtBQVIsQ0FBY1UsV0FBaEMsQ0FEZCxFQUVHbkIsSUFGSCxDQUVRLE1BQU07QUFDVixhQUFLWixRQUFMLENBQWNzQixPQUFkLENBQXNCQyxVQUF0QixHQUFtQ04sUUFBUUUsWUFBUixDQUFxQnNCLEVBQXhEOztBQUVBO0FBQ0E7QUFDQXhCLGdCQUFRQyxlQUFSLENBQXdCK0IsUUFBeEIsR0FBbUMsS0FBbkM7QUFDQWhDLGdCQUFRRSxZQUFSLENBQXFCOEIsUUFBckIsR0FBZ0MsSUFBaEM7O0FBRUE7QUFDQSxhQUFLakQsUUFBTCxDQUFjc0QsTUFBZDs7QUFFQXRDLGdCQUFRQyxPQUFSO0FBQ0QsT0FkSDtBQWVELEtBL0NNLENBQVA7QUFnREQ7O0FBRUQ7Ozs7OztBQU1Bc0MsZ0JBQWV6QyxPQUFmLEVBQXdCO0FBQ3RCLFdBQU8sS0FBS0QsV0FBTCxDQUFpQkMsT0FBakIsRUFDSkYsSUFESSxDQUNDSyxXQUFXLEtBQUtpQixXQUFMLENBQWlCakIsT0FBakIsQ0FEWixFQUVKdUMsS0FGSSxDQUVFQyxVQUFVLHNCQUFPQSxNQUFQLENBRlosQ0FBUDtBQUdEO0FBckptQixDO2tCQXdKUDVELGUiLCJmaWxlIjoiY29udGV4dC1zd2l0Y2hlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBkZXZsb2cgZnJvbSAnLi9kZXZsb2cnO1xuaW1wb3J0IERhdGFiYXNlIGZyb20gJy4vZGF0YWJhc2UnO1xuaW1wb3J0IFBhY2thZ2VzIGZyb20gJy4vcGFja2FnZXMnO1xuaW1wb3J0IHsgUExVR0lOX05BTUUsIE1FU1NBR0VTIH0gZnJvbSAnLi8uLi9jb25zdGFudHMvYmFzZSc7XG5cbi8qKlxuICogQ2xhc3MgcmVwcmVzZW50aW5nIHRoZSBEYXRhYmFzZVxuICovXG5jbGFzcyBDb250ZXh0U3dpdGNoZXIge1xuXG4gIHN0YXRpYyBpbnN0YW5jZTtcblxuICAvKipcbiAgICogZGVzY3JpcHRpb25cbiAgICpcbiAgICogQHRvZG8gaW1wcm92ZSBKU0RvY1xuICAgKi9cbiAgY29uc3RydWN0b3IgKCkge1xuICAgIGlmIChDb250ZXh0U3dpdGNoZXIuaW5zdGFuY2UpIHtcbiAgICAgIHJldHVybiBDb250ZXh0U3dpdGNoZXIuaW5zdGFuY2U7XG4gICAgfVxuICAgIENvbnRleHRTd2l0Y2hlci5pbnN0YW5jZSA9IHRoaXM7XG5cbiAgICB0aGlzLmRhdGFiYXNlID0gbmV3IERhdGFiYXNlKCk7XG4gICAgdGhpcy5wYWNrYWdlcyA9IG5ldyBQYWNrYWdlcygpO1xuICB9XG5cbiAgLyoqXG4gICAqIGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBzdGF0ZXMgLSBkZXNjcmlwdGlvblxuICAgKi9cbiAgc2F2ZVBhY2thZ2VzIChzdGF0ZXMpIHtcbiAgICBzdGF0ZXNbJ3RyZWUtdmlldyddID0gdGhpcy5wYWNrYWdlcy50cmVlVmlldy5zYXZlKCk7XG4gICAgc3RhdGVzWydmaW5kLWFuZC1yZXBsYWNlJ10gPSB0aGlzLnBhY2thZ2VzLmZpbmRBbmRSZXBsYWNlLnNhdmUoKTtcbiAgICB0aGlzLnBhY2thZ2VzLnN0YXR1c0Jhci5zYXZlKCk7IC8vIFRPRE86IHJlbW92ZSBhcyBpdCBkb2VzIG5vdGhpbmdcbiAgICB0aGlzLnBhY2thZ2VzLmxpbnRlclVJRGVmYXVsdC5zYXZlKCk7IC8vIFRPRE86IHJlbW92ZSBhcyBpdCBkb2VzIG5vdGhpbmdcbiAgICB0aGlzLnBhY2thZ2VzLmxpbnRlci5zYXZlKCk7IC8vIFRPRE86IHJlbW92ZSBhcyBpdCBkb2VzIG5vdGhpbmdcbiAgfVxuXG4gIC8qKlxuICAgKiBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gc3RhdGVzIC0gZGVzY3JpcHRpb25cbiAgICogQHJldHVybnMge1Byb21pc2V9IGRlc2NyaXB0aW9uXG4gICAqL1xuICBsb2FkUGFja2FnZXMgKHN0YXRlcykge1xuICAgIHJldHVybiB0aGlzLnBhY2thZ2VzLnRyZWVWaWV3LmxvYWQoc3RhdGVzWyd0cmVlLXZpZXcnXSlcbiAgICAgIC50aGVuKCgpID0+IHRoaXMucGFja2FnZXMuZmluZEFuZFJlcGxhY2UubG9hZChzdGF0ZXNbJ2ZpbmQtYW5kLXJlcGxhY2UnXSkpXG4gICAgICAudGhlbigoKSA9PiB0aGlzLnBhY2thZ2VzLnN0YXR1c0Jhci5sb2FkKCkpXG4gICAgICAudGhlbigoKSA9PiB0aGlzLnBhY2thZ2VzLmxpbnRlci5sb2FkKCkpXG4gICAgICAudGhlbigoKSA9PiB0aGlzLnBhY2thZ2VzLmxpbnRlclVJRGVmYXVsdC5sb2FkKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBwcm9qZWN0IC0gZGVzY3JpcHRpb25cbiAgICogQHJldHVybnMge1Byb21pc2V9IGRlc2NyaXB0aW9uXG4gICAqL1xuICBzYXZlQ29udGV4dCAocHJvamVjdCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgIGNvbnN0IGNvbnRleHQgPSB7XG4gICAgICAgIGN1cnJlbnRfcHJvamVjdDogbnVsbCxcbiAgICAgICAgbmV4dF9wcm9qZWN0OiBwcm9qZWN0LFxuICAgICAgICBrZXk6IG51bGwsXG4gICAgICAgIHN0YXRlOiBudWxsXG4gICAgICB9O1xuXG4gICAgICBjb250ZXh0LmN1cnJlbnRfcHJvamVjdCA9IHRoaXMuZGF0YWJhc2UuY29udGVudC5zZWxlY3RlZElkID9cbiAgICAgICAgdGhpcy5kYXRhYmFzZS5jb250ZW50Lm1hcFt0aGlzLmRhdGFiYXNlLmNvbnRlbnQuc2VsZWN0ZWRJZF0gOlxuICAgICAgICB7IG1vZGVsOiB7IHBhdGhzOiBhdG9tLnByb2plY3QuZ2V0UGF0aHMoKSB9IH07XG5cbiAgICAgIGRldmxvZygnc2F2ZSBjb250ZXh0JywgY29udGV4dC5jdXJyZW50X3Byb2plY3QpO1xuXG4gICAgICAvLyB2YWxpZGF0ZSBpZiBzYW1lIHByb2plY3RzIChwYXRocykgLSB0aXA6IHVzZSBhdG9tLmdldFN0YXRlS2V5XG5cbiAgICAgIGNvbnRleHQua2V5ID0gYXRvbS5nZXRTdGF0ZUtleShjb250ZXh0LmN1cnJlbnRfcHJvamVjdC5tb2RlbC5wYXRocyk7XG4gICAgICBjb250ZXh0LnN0YXRlID0gYXRvbS5zZXJpYWxpemUoKTtcbiAgICAgIGNvbnRleHQuc3RhdGUuZXh0cmFTdGF0ZXMgPSB7fTtcblxuICAgICAgaWYgKGNvbnRleHQua2V5ICYmIGNvbnRleHQuc3RhdGUpIHtcbiAgICAgICAgdGhpcy5zYXZlUGFja2FnZXMoY29udGV4dC5zdGF0ZS5leHRyYVN0YXRlcyk7XG4gICAgICAgIGF0b20uZ2V0U3RvcmFnZUZvbGRlcigpLnN0b3JlU3luYyhjb250ZXh0LmtleSwgY29udGV4dC5zdGF0ZSk7XG4gICAgICB9XG5cbiAgICAgIHJlc29sdmUoY29udGV4dCk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogZGVzY3JpcHRpb25cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgLSBkZXNjcmlwdGlvblxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gZGVzY3JpcHRpb25cbiAgICovXG4gIGxvYWRDb250ZXh0IChjb250ZXh0KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGRldmxvZygnbG9hZCBjb250ZXh0JywgY29udGV4dC5uZXh0X3Byb2plY3QpO1xuXG4gICAgICBpZiAoY29udGV4dC5uZXh0X3Byb2plY3QudHlwZSAhPT0gJ3Byb2plY3QnKSB7XG4gICAgICAgIHJldHVybiByZWplY3QoTUVTU0FHRVMuQ09OVEVYVC5OT1RfQV9QUk9KRUNUKTtcbiAgICAgIH1cbiAgICAgIGlmICghdGhpcy5kYXRhYmFzZS5jb250ZW50Lmlkcy5pbmNsdWRlcyhjb250ZXh0Lm5leHRfcHJvamVjdC5pZCkpIHtcbiAgICAgICAgcmV0dXJuIHJlamVjdChNRVNTQUdFUy5DT05URVhULk5PX1ZBTElEX1BST0pFQ1RfSUQpO1xuICAgICAgfVxuXG4gICAgICBjb250ZXh0LmtleSA9IGF0b20uZ2V0U3RhdGVLZXkoY29udGV4dC5uZXh0X3Byb2plY3QubW9kZWwucGF0aHMpO1xuICAgICAgY29udGV4dC5zdGF0ZSA9IGF0b20uZ2V0U3RvcmFnZUZvbGRlcigpLmxvYWQoY29udGV4dC5rZXkpO1xuXG4gICAgICBpZiAoXG4gICAgICAgICFjb250ZXh0LnN0YXRlIHx8XG4gICAgICAgIGF0b20uZ2V0U3RhdGVLZXkoY29udGV4dC5zdGF0ZS5wcm9qZWN0LnBhdGhzKSAhPT0gY29udGV4dC5rZXlcbiAgICAgICkge1xuICAgICAgICBhdG9tLnByb2plY3Quc2V0UGF0aHMoY29udGV4dC5uZXh0X3Byb2plY3QubW9kZWwucGF0aHMpO1xuICAgICAgICBhdG9tLndvcmtzcGFjZS5nZXRDZW50ZXIoKS5wYW5lQ29udGFpbmVyLmFjdGl2ZVBhbmUuZGVzdHJveSgpO1xuXG4gICAgICAgIHRoaXMuZGF0YWJhc2UuY29udGVudC5zZWxlY3RlZElkID0gY29udGV4dC5uZXh0X3Byb2plY3QuaWQ7XG5cbiAgICAgICAgY29udGV4dC5jdXJyZW50X3Byb2plY3Quc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgY29udGV4dC5uZXh0X3Byb2plY3Quc2VsZWN0ZWQgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiByZXNvbHZlKGNvbnRleHQpO1xuICAgICAgfVxuXG4gICAgICAvLyB0aGlzIG11c3QgcnVuIG9ubHkgaWYgY29udGV4dCBpcyB0byBiZSBrZXB0IGluIHNhbWUgaW5zdGFuY2VcbiAgICAgIGNvbnRleHQuc3RhdGUud29ya3NwYWNlLnBhbmVDb250YWluZXJzLmxlZnQucGFuZUNvbnRhaW5lciA9IHt9O1xuICAgICAgY29udGV4dC5zdGF0ZS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lcnMucmlnaHQucGFuZUNvbnRhaW5lciA9IHt9O1xuXG4gICAgICBhdG9tLmRlc2VyaWFsaXplKGNvbnRleHQuc3RhdGUpXG4gICAgICAgIC50aGVuKCgpID0+IHRoaXMubG9hZFBhY2thZ2VzKGNvbnRleHQuc3RhdGUuZXh0cmFTdGF0ZXMpKVxuICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgdGhpcy5kYXRhYmFzZS5jb250ZW50LnNlbGVjdGVkSWQgPSBjb250ZXh0Lm5leHRfcHJvamVjdC5pZDtcblxuICAgICAgICAgIC8vIFRPRE86IG5lZWRzIGEgYmV0dGVyIG1lY2hhbmlzbSBiZWNhdXNlIGNvbGxhcHNpbmcgYSBncm91cFxuICAgICAgICAgIC8vIHdpbGwgZXJhc2UgdGhlIHNlbGVjdGVkIHByb2plY3RcbiAgICAgICAgICBjb250ZXh0LmN1cnJlbnRfcHJvamVjdC5zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgICAgIGNvbnRleHQubmV4dF9wcm9qZWN0LnNlbGVjdGVkID0gdHJ1ZTtcblxuICAgICAgICAgIC8vIFRPRE86IHRoaXMgaXMgYmFkIGZvciBwZXJmb3JtYW5jZVxuICAgICAgICAgIHRoaXMuZGF0YWJhc2UudXBkYXRlKCk7XG5cbiAgICAgICAgICByZXNvbHZlKGNvbnRleHQpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gcHJvamVjdCAtIGRlc2NyaXB0aW9uXG4gICAqIEByZXR1cm5zIHtQcm9taXNlfSBkZXNjcmlwdGlvblxuICAgKi9cbiAgc3dpdGNoQ29udGV4dCAocHJvamVjdCkge1xuICAgIHJldHVybiB0aGlzLnNhdmVDb250ZXh0KHByb2plY3QpXG4gICAgICAudGhlbihjb250ZXh0ID0+IHRoaXMubG9hZENvbnRleHQoY29udGV4dCkpXG4gICAgICAuY2F0Y2gocmVhc29uID0+IGRldmxvZyhyZWFzb24pKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBDb250ZXh0U3dpdGNoZXI7XG4iXX0=