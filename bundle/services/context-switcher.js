Object.defineProperty(exports, "__esModule", {
  value: true
});

var _devlog = require('./devlog');

var _devlog2 = _interopRequireDefault(_devlog);

var _database = require('./database');

var _database2 = _interopRequireDefault(_database);

var _packages = require('./packages');

var _packages2 = _interopRequireDefault(_packages);

var _base = require('./../constants/base');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Class representing the Database
 */
let ContextSwitcher = class ContextSwitcher {

  /**
   * description
   *
   * @todo improve JSDoc
   */
  constructor() {
    if (ContextSwitcher.instance) {
      return ContextSwitcher.instance;
    }
    ContextSwitcher.instance = this;

    this.database = new _database2.default();
    this.packages = new _packages2.default();
  }

  /**
   * description
   *
   * @param {Object} states - description
   */
  savePackages(states) {
    states['tree-view'] = this.packages.treeView.save();
    states['find-and-replace'] = this.packages.findAndReplace.save();
    this.packages.statusBar.save();
    this.packages.linterUIDefault.save();
    this.packages.linter.save();
  }

  /**
   * description
   *
   * @param {Object} states - description
   * @returns {Promise} description
   */
  loadPackages(states) {
    return this.packages.treeView.load(states['tree-view']).then(() => this.packages.findAndReplace.load(states['find-and-replace'])).then(() => this.packages.statusBar.load()).then(() => this.packages.linter.load()).then(() => this.packages.linterUIDefault.load());
  }

  /**
   * description
   *
   * @param {Object} project - description
   * @returns {Promise} description
   */
  saveContext(project) {
    return new Promise(resolve => {
      const context = {
        current_project: null,
        next_project: project,
        key: null,
        state: null
      };

      context.current_project = this.database.content.selectedId ? this.database.content.map[this.database.content.selectedId] : { model: { paths: atom.project.getPaths() } };

      (0, _devlog2.default)('save context', context.current_project);

      // validate if same projects (paths) - tip: use atom.getStateKey

      context.key = atom.getStateKey(context.current_project.model.paths);
      context.state = atom.serialize();
      context.state.extraStates = {};

      if (context.key && context.state) {
        this.savePackages(context.state.extraStates);
        atom.getStorageFolder().storeSync(context.key, context.state);
      }

      resolve(context);
    });
  }

  /**
   * description
   *
   * @param {Object} context - description
   * @returns {Promise} description
   */
  loadContext(context) {
    return new Promise((resolve, reject) => {
      (0, _devlog2.default)('load context', context.next_project);

      if (context.next_project.type !== 'project') {
        return reject(_base.MESSAGES.CONTEXT.NOT_A_PROJECT);
      }
      if (!this.database.content.ids.includes(context.next_project.id)) {
        return reject(_base.MESSAGES.CONTEXT.NO_VALID_PROJECT_ID);
      }

      context.key = atom.getStateKey(context.next_project.model.paths);
      context.state = atom.getStorageFolder().load(context.key);

      if (!context.state || atom.getStateKey(context.state.project.paths) !== context.key) {
        atom.project.setPaths(context.next_project.model.paths);
        atom.workspace.getCenter().paneContainer.activePane.destroy();

        this.database.content.selectedId = context.next_project.id;

        context.current_project.selected = false;
        context.next_project.selected = true;

        return resolve(context);
      }

      // this must run only if context is to be kept in same instance
      context.state.workspace.paneContainers.bottom.paneContainer = {};
      context.state.workspace.paneContainers.left.paneContainer = {};
      context.state.workspace.paneContainers.center.paneContainer = {};
      context.state.workspace.paneContainers.right.paneContainer = {};

      atom.deserialize(context.state).then(() => this.loadPackages(context.state.extraStates)).then(() => {
        this.database.content.selectedId = context.next_project.id;

        // TODO: needs a better mechanism because collapsing a group
        // will erase the selected project
        context.current_project.selected = false;
        context.next_project.selected = true;

        // TODO: this is bad for performance
        this.database.update();

        resolve(context);
      });
    });
  }

  /**
   * description
   *
   * @param {Object} project - description
   * @returns {Promise} description
   */
  switchContext(project) {
    return this.saveContext(project).then(context => this.loadContext(context)).catch(reason => (0, _devlog2.default)(reason));
  }
};
exports.default = ContextSwitcher;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9zZXJ2aWNlcy9jb250ZXh0LXN3aXRjaGVyLmpzIl0sIm5hbWVzIjpbIkNvbnRleHRTd2l0Y2hlciIsImNvbnN0cnVjdG9yIiwiaW5zdGFuY2UiLCJkYXRhYmFzZSIsInBhY2thZ2VzIiwic2F2ZVBhY2thZ2VzIiwic3RhdGVzIiwidHJlZVZpZXciLCJzYXZlIiwiZmluZEFuZFJlcGxhY2UiLCJzdGF0dXNCYXIiLCJsaW50ZXJVSURlZmF1bHQiLCJsaW50ZXIiLCJsb2FkUGFja2FnZXMiLCJsb2FkIiwidGhlbiIsInNhdmVDb250ZXh0IiwicHJvamVjdCIsIlByb21pc2UiLCJyZXNvbHZlIiwiY29udGV4dCIsImN1cnJlbnRfcHJvamVjdCIsIm5leHRfcHJvamVjdCIsImtleSIsInN0YXRlIiwiY29udGVudCIsInNlbGVjdGVkSWQiLCJtYXAiLCJtb2RlbCIsInBhdGhzIiwiYXRvbSIsImdldFBhdGhzIiwiZ2V0U3RhdGVLZXkiLCJzZXJpYWxpemUiLCJleHRyYVN0YXRlcyIsImdldFN0b3JhZ2VGb2xkZXIiLCJzdG9yZVN5bmMiLCJsb2FkQ29udGV4dCIsInJlamVjdCIsInR5cGUiLCJDT05URVhUIiwiTk9UX0FfUFJPSkVDVCIsImlkcyIsImluY2x1ZGVzIiwiaWQiLCJOT19WQUxJRF9QUk9KRUNUX0lEIiwic2V0UGF0aHMiLCJ3b3Jrc3BhY2UiLCJnZXRDZW50ZXIiLCJwYW5lQ29udGFpbmVyIiwiYWN0aXZlUGFuZSIsImRlc3Ryb3kiLCJzZWxlY3RlZCIsInBhbmVDb250YWluZXJzIiwiYm90dG9tIiwibGVmdCIsImNlbnRlciIsInJpZ2h0IiwiZGVzZXJpYWxpemUiLCJ1cGRhdGUiLCJzd2l0Y2hDb250ZXh0IiwiY2F0Y2giLCJyZWFzb24iXSwibWFwcGluZ3MiOiI7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7SUFHTUEsZSxHQUFOLE1BQU1BLGVBQU4sQ0FBc0I7O0FBSXBCOzs7OztBQUtBQyxnQkFB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IGRldmxvZyBmcm9tICcuL2RldmxvZyc7XG5pbXBvcnQgRGF0YWJhc2UgZnJvbSAnLi9kYXRhYmFzZSc7XG5pbXBvcnQgUGFja2FnZXMgZnJvbSAnLi9wYWNrYWdlcyc7XG5pbXBvcnQgeyBQTFVHSU5fTkFNRSwgTUVTU0FHRVMgfSBmcm9tICcuLy4uL2NvbnN0YW50cy9iYXNlJztcblxuLyoqXG4gKiBDbGFzcyByZXByZXNlbnRpbmcgdGhlIERhdGFiYXNlXG4gKi9cbmNsYXNzIENvbnRleHRTd2l0Y2hlciB7XG5cbiAgc3RhdGljIGluc3RhbmNlO1xuXG4gIC8qKlxuICAgKiBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBAdG9kbyBpbXByb3ZlIEpTRG9jXG4gICAqL1xuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgaWYgKENvbnRleHRTd2l0Y2hlci5pbnN0YW5jZSkge1xuICAgICAgcmV0dXJuIENvbnRleHRTd2l0Y2hlci5pbnN0YW5jZTtcbiAgICB9XG4gICAgQ29udGV4dFN3aXRjaGVyLmluc3RhbmNlID0gdGhpcztcblxuICAgIHRoaXMuZGF0YWJhc2UgPSBuZXcgRGF0YWJhc2UoKTtcbiAgICB0aGlzLnBhY2thZ2VzID0gbmV3IFBhY2thZ2VzKCk7XG4gIH1cblxuICAvKipcbiAgICogZGVzY3JpcHRpb25cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IHN0YXRlcyAtIGRlc2NyaXB0aW9uXG4gICAqL1xuICBzYXZlUGFja2FnZXMgKHN0YXRlcykge1xuICAgIHN0YXRlc1sndHJlZS12aWV3J10gPSB0aGlzLnBhY2thZ2VzLnRyZWVWaWV3LnNhdmUoKTtcbiAgICBzdGF0ZXNbJ2ZpbmQtYW5kLXJlcGxhY2UnXSA9IHRoaXMucGFja2FnZXMuZmluZEFuZFJlcGxhY2Uuc2F2ZSgpO1xuICAgIHRoaXMucGFja2FnZXMuc3RhdHVzQmFyLnNhdmUoKTtcbiAgICB0aGlzLnBhY2thZ2VzLmxpbnRlclVJRGVmYXVsdC5zYXZlKCk7XG4gICAgdGhpcy5wYWNrYWdlcy5saW50ZXIuc2F2ZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBzdGF0ZXMgLSBkZXNjcmlwdGlvblxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gZGVzY3JpcHRpb25cbiAgICovXG4gIGxvYWRQYWNrYWdlcyAoc3RhdGVzKSB7XG4gICAgcmV0dXJuIHRoaXMucGFja2FnZXMudHJlZVZpZXcubG9hZChzdGF0ZXNbJ3RyZWUtdmlldyddKVxuICAgICAgLnRoZW4oKCkgPT4gdGhpcy5wYWNrYWdlcy5maW5kQW5kUmVwbGFjZS5sb2FkKHN0YXRlc1snZmluZC1hbmQtcmVwbGFjZSddKSlcbiAgICAgIC50aGVuKCgpID0+IHRoaXMucGFja2FnZXMuc3RhdHVzQmFyLmxvYWQoKSlcbiAgICAgIC50aGVuKCgpID0+IHRoaXMucGFja2FnZXMubGludGVyLmxvYWQoKSlcbiAgICAgIC50aGVuKCgpID0+IHRoaXMucGFja2FnZXMubGludGVyVUlEZWZhdWx0LmxvYWQoKSk7XG4gIH1cblxuICAvKipcbiAgICogZGVzY3JpcHRpb25cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IHByb2plY3QgLSBkZXNjcmlwdGlvblxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gZGVzY3JpcHRpb25cbiAgICovXG4gIHNhdmVDb250ZXh0IChwcm9qZWN0KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgY29uc3QgY29udGV4dCA9IHtcbiAgICAgICAgY3VycmVudF9wcm9qZWN0OiBudWxsLFxuICAgICAgICBuZXh0X3Byb2plY3Q6IHByb2plY3QsXG4gICAgICAgIGtleTogbnVsbCxcbiAgICAgICAgc3RhdGU6IG51bGxcbiAgICAgIH07XG5cbiAgICAgIGNvbnRleHQuY3VycmVudF9wcm9qZWN0ID0gdGhpcy5kYXRhYmFzZS5jb250ZW50LnNlbGVjdGVkSWQgP1xuICAgICAgICB0aGlzLmRhdGFiYXNlLmNvbnRlbnQubWFwW3RoaXMuZGF0YWJhc2UuY29udGVudC5zZWxlY3RlZElkXSA6XG4gICAgICAgIHsgbW9kZWw6IHsgcGF0aHM6IGF0b20ucHJvamVjdC5nZXRQYXRocygpIH0gfTtcblxuICAgICAgZGV2bG9nKCdzYXZlIGNvbnRleHQnLCBjb250ZXh0LmN1cnJlbnRfcHJvamVjdCk7XG5cbiAgICAgIC8vIHZhbGlkYXRlIGlmIHNhbWUgcHJvamVjdHMgKHBhdGhzKSAtIHRpcDogdXNlIGF0b20uZ2V0U3RhdGVLZXlcblxuICAgICAgY29udGV4dC5rZXkgPSBhdG9tLmdldFN0YXRlS2V5KGNvbnRleHQuY3VycmVudF9wcm9qZWN0Lm1vZGVsLnBhdGhzKTtcbiAgICAgIGNvbnRleHQuc3RhdGUgPSBhdG9tLnNlcmlhbGl6ZSgpO1xuICAgICAgY29udGV4dC5zdGF0ZS5leHRyYVN0YXRlcyA9IHt9O1xuXG4gICAgICBpZiAoY29udGV4dC5rZXkgJiYgY29udGV4dC5zdGF0ZSkge1xuICAgICAgICB0aGlzLnNhdmVQYWNrYWdlcyhjb250ZXh0LnN0YXRlLmV4dHJhU3RhdGVzKTtcbiAgICAgICAgYXRvbS5nZXRTdG9yYWdlRm9sZGVyKCkuc3RvcmVTeW5jKGNvbnRleHQua2V5LCBjb250ZXh0LnN0YXRlKTtcbiAgICAgIH1cblxuICAgICAgcmVzb2x2ZShjb250ZXh0KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gY29udGV4dCAtIGRlc2NyaXB0aW9uXG4gICAqIEByZXR1cm5zIHtQcm9taXNlfSBkZXNjcmlwdGlvblxuICAgKi9cbiAgbG9hZENvbnRleHQgKGNvbnRleHQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgZGV2bG9nKCdsb2FkIGNvbnRleHQnLCBjb250ZXh0Lm5leHRfcHJvamVjdCk7XG5cbiAgICAgIGlmIChjb250ZXh0Lm5leHRfcHJvamVjdC50eXBlICE9PSAncHJvamVjdCcpIHtcbiAgICAgICAgcmV0dXJuIHJlamVjdChNRVNTQUdFUy5DT05URVhULk5PVF9BX1BST0pFQ1QpO1xuICAgICAgfVxuICAgICAgaWYgKCF0aGlzLmRhdGFiYXNlLmNvbnRlbnQuaWRzLmluY2x1ZGVzKGNvbnRleHQubmV4dF9wcm9qZWN0LmlkKSkge1xuICAgICAgICByZXR1cm4gcmVqZWN0KE1FU1NBR0VTLkNPTlRFWFQuTk9fVkFMSURfUFJPSkVDVF9JRCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnRleHQua2V5ID0gYXRvbS5nZXRTdGF0ZUtleShjb250ZXh0Lm5leHRfcHJvamVjdC5tb2RlbC5wYXRocyk7XG4gICAgICBjb250ZXh0LnN0YXRlID0gYXRvbS5nZXRTdG9yYWdlRm9sZGVyKCkubG9hZChjb250ZXh0LmtleSk7XG5cbiAgICAgIGlmIChcbiAgICAgICAgIWNvbnRleHQuc3RhdGUgfHxcbiAgICAgICAgYXRvbS5nZXRTdGF0ZUtleShjb250ZXh0LnN0YXRlLnByb2plY3QucGF0aHMpICE9PSBjb250ZXh0LmtleVxuICAgICAgKSB7XG4gICAgICAgIGF0b20ucHJvamVjdC5zZXRQYXRocyhjb250ZXh0Lm5leHRfcHJvamVjdC5tb2RlbC5wYXRocyk7XG4gICAgICAgIGF0b20ud29ya3NwYWNlLmdldENlbnRlcigpLnBhbmVDb250YWluZXIuYWN0aXZlUGFuZS5kZXN0cm95KCk7XG5cbiAgICAgICAgdGhpcy5kYXRhYmFzZS5jb250ZW50LnNlbGVjdGVkSWQgPSBjb250ZXh0Lm5leHRfcHJvamVjdC5pZDtcblxuICAgICAgICBjb250ZXh0LmN1cnJlbnRfcHJvamVjdC5zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgICBjb250ZXh0Lm5leHRfcHJvamVjdC5zZWxlY3RlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIHJlc29sdmUoY29udGV4dCk7XG4gICAgICB9XG5cbiAgICAgIC8vIHRoaXMgbXVzdCBydW4gb25seSBpZiBjb250ZXh0IGlzIHRvIGJlIGtlcHQgaW4gc2FtZSBpbnN0YW5jZVxuICAgICAgY29udGV4dC5zdGF0ZS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lcnMuYm90dG9tLnBhbmVDb250YWluZXIgPSB7fTtcbiAgICAgIGNvbnRleHQuc3RhdGUud29ya3NwYWNlLnBhbmVDb250YWluZXJzLmxlZnQucGFuZUNvbnRhaW5lciA9IHt9O1xuICAgICAgY29udGV4dC5zdGF0ZS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lcnMuY2VudGVyLnBhbmVDb250YWluZXIgPSB7fTtcbiAgICAgIGNvbnRleHQuc3RhdGUud29ya3NwYWNlLnBhbmVDb250YWluZXJzLnJpZ2h0LnBhbmVDb250YWluZXIgPSB7fTtcblxuICAgICAgYXRvbS5kZXNlcmlhbGl6ZShjb250ZXh0LnN0YXRlKVxuICAgICAgICAudGhlbigoKSA9PiB0aGlzLmxvYWRQYWNrYWdlcyhjb250ZXh0LnN0YXRlLmV4dHJhU3RhdGVzKSlcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHRoaXMuZGF0YWJhc2UuY29udGVudC5zZWxlY3RlZElkID0gY29udGV4dC5uZXh0X3Byb2plY3QuaWQ7XG5cbiAgICAgICAgICAvLyBUT0RPOiBuZWVkcyBhIGJldHRlciBtZWNoYW5pc20gYmVjYXVzZSBjb2xsYXBzaW5nIGEgZ3JvdXBcbiAgICAgICAgICAvLyB3aWxsIGVyYXNlIHRoZSBzZWxlY3RlZCBwcm9qZWN0XG4gICAgICAgICAgY29udGV4dC5jdXJyZW50X3Byb2plY3Quc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICBjb250ZXh0Lm5leHRfcHJvamVjdC5zZWxlY3RlZCA9IHRydWU7XG5cbiAgICAgICAgICAvLyBUT0RPOiB0aGlzIGlzIGJhZCBmb3IgcGVyZm9ybWFuY2VcbiAgICAgICAgICB0aGlzLmRhdGFiYXNlLnVwZGF0ZSgpO1xuXG4gICAgICAgICAgcmVzb2x2ZShjb250ZXh0KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogZGVzY3JpcHRpb25cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IHByb2plY3QgLSBkZXNjcmlwdGlvblxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gZGVzY3JpcHRpb25cbiAgICovXG4gIHN3aXRjaENvbnRleHQgKHByb2plY3QpIHtcbiAgICByZXR1cm4gdGhpcy5zYXZlQ29udGV4dChwcm9qZWN0KVxuICAgICAgLnRoZW4oY29udGV4dCA9PiB0aGlzLmxvYWRDb250ZXh0KGNvbnRleHQpKVxuICAgICAgLmNhdGNoKHJlYXNvbiA9PiBkZXZsb2cocmVhc29uKSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQ29udGV4dFN3aXRjaGVyO1xuIl19