'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _devlog = require('./devlog');

var _devlog2 = _interopRequireDefault(_devlog);

var _database = require('./database');

var _database2 = _interopRequireDefault(_database);

var _packages = require('./packages');

var _packages2 = _interopRequireDefault(_packages);

var _base = require('./../constants/base');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Class representing the Database
 */
let ContextSwitcher = class ContextSwitcher {

  /**
   * description
   *
   * @todo improve JSDoc
   */
  constructor() {
    if (ContextSwitcher.instance) {
      return ContextSwitcher.instance;
    }
    ContextSwitcher.instance = this;

    this.database = new _database2.default();
    this.packages = new _packages2.default();
  }

  /**
   * description
   *
   * @param {Object} states - description
   */
  savePackages(states) {
    states.treeView = this.packages.treeView.save();
    states.findAndReplace = this.packages.findAndReplace.save();
    this.packages.linterUIDefault.save();
    this.packages.linter.save();
  }

  /**
   * description
   *
   * @param {Object} states - description
   * @returns {Promise} description
   */
  loadOrReloadPackages(states) {
    if (!states) {
      return Promise.resolve();
    }
    return this.packages.treeView.load(states.treeView).then(() => this.packages.findAndReplace.load(states.findAndReplace)).then(() => this.packages.statusBar.reload()).then(() => this.packages.linter.load()).then(() => this.packages.linterUIDefault.load());
  }

  /**
   * description
   *
   * @param {Object} context - description
   * @returns {Promise} description
   */
  saveContext(context) {
    return new Promise(resolve => {
      context.current_project = this.database.content.selectedId ? this.database.content.map[this.database.content.selectedId] : { model: { paths: atom.project.getPaths() } };

      (0, _devlog2.default)('start save context', context.current_project);

      context.key = atom.getStateKey(context.current_project.model.paths);

      context.state = atom.serialize();

      context.docker = atom.workspace.getCenter();

      context.state.extraStates = {};

      if (context.key && context.state) {
        this.savePackages(context.state.extraStates);
        atom.getStorageFolder().storeSync(context.key, context.state);
      }

      (0, _devlog2.default)('end save context', context);

      resolve(context);
    });
  }

  /**
   * description
   *
   * @param {Object} context - description
   * @returns {Promise} description
   */
  loadContext(context) {
    return new Promise((resolve, reject) => {
      (0, _devlog2.default)('start load context', context.next_project);

      context.key = atom.getStateKey(context.next_project.model.paths);
      context.state = atom.getStorageFolder().load(context.key);

      if (!context.state || atom.getStateKey(context.state.project.paths) !== context.key) {
        atom.project.setPaths(context.next_project.model.paths);

        const pane = atom.workspace.getCenter().paneContainer.activePane;

        if (pane) {
          pane.destroy();
        }

        this.database.content.selectedId = context.next_project.id;

        context.current_project.selected = false;
        context.next_project.selected = true;

        return resolve(context);
      }

      atom.project.deserialize(context.state.project).then(() => atom.workspace.getCenter().deserialize(context.state.workspace.paneContainers.center, atom.deserializers)).then(() => this.loadOrReloadPackages(context.state.extraStates)).then(() => {
        this.database.content.selectedId = context.next_project.id;

        context.current_project.selected = false;
        context.next_project.selected = true;

        // TODO: this is bad for performance
        this.database.update();

        (0, _devlog2.default)('end load context');

        resolve(context);
      });
    });
  }

  /**
   * @param {Object} project - description
   * @returns {Promise} description
   */
  validateContext(project) {
    return new Promise((resolve, reject) => {
      if (!atom.getStorageFolder) {
        reject(_base.MESSAGES.ATOM.INVALID_ATOM_API);
      } else if (project.id === this.database.content.selectedId) {
        reject(_base.MESSAGES.CONTEXT.SAME_PROJECT_ID);
      } else if (project.type !== 'project') {
        return reject(_base.MESSAGES.CONTEXT.NOT_A_PROJECT);
      } else if (!this.database.content.ids.includes(project.id)) {
        return reject(_base.MESSAGES.CONTEXT.NO_VALID_PROJECT_ID);
      }

      resolve({
        current_project: null,
        next_project: project,
        key: null,
        state: null
      });
    });
  }

  /**
   * description
   *
   * @param {Object} project - description
   * @returns {Promise} description
   */
  switchContext(project) {
    return this.validateContext(project).then(context => this.saveContext(context)).then(context => this.loadContext(context)).catch(reason => (0, _devlog2.default)('switching error', reason));
  }
};
exports.default = ContextSwitcher;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9zZXJ2aWNlcy9jb250ZXh0LXN3aXRjaGVyLmpzIl0sIm5hbWVzIjpbIkNvbnRleHRTd2l0Y2hlciIsImNvbnN0cnVjdG9yIiwiaW5zdGFuY2UiLCJkYXRhYmFzZSIsInBhY2thZ2VzIiwic2F2ZVBhY2thZ2VzIiwic3RhdGVzIiwidHJlZVZpZXciLCJzYXZlIiwiZmluZEFuZFJlcGxhY2UiLCJsaW50ZXJVSURlZmF1bHQiLCJsaW50ZXIiLCJsb2FkT3JSZWxvYWRQYWNrYWdlcyIsIlByb21pc2UiLCJyZXNvbHZlIiwibG9hZCIsInRoZW4iLCJzdGF0dXNCYXIiLCJyZWxvYWQiLCJzYXZlQ29udGV4dCIsImNvbnRleHQiLCJjdXJyZW50X3Byb2plY3QiLCJjb250ZW50Iiwic2VsZWN0ZWRJZCIsIm1hcCIsIm1vZGVsIiwicGF0aHMiLCJhdG9tIiwicHJvamVjdCIsImdldFBhdGhzIiwia2V5IiwiZ2V0U3RhdGVLZXkiLCJzdGF0ZSIsInNlcmlhbGl6ZSIsImRvY2tlciIsIndvcmtzcGFjZSIsImdldENlbnRlciIsImV4dHJhU3RhdGVzIiwiZ2V0U3RvcmFnZUZvbGRlciIsInN0b3JlU3luYyIsImxvYWRDb250ZXh0IiwicmVqZWN0IiwibmV4dF9wcm9qZWN0Iiwic2V0UGF0aHMiLCJwYW5lIiwicGFuZUNvbnRhaW5lciIsImFjdGl2ZVBhbmUiLCJkZXN0cm95IiwiaWQiLCJzZWxlY3RlZCIsImRlc2VyaWFsaXplIiwicGFuZUNvbnRhaW5lcnMiLCJjZW50ZXIiLCJkZXNlcmlhbGl6ZXJzIiwidXBkYXRlIiwidmFsaWRhdGVDb250ZXh0IiwiQVRPTSIsIklOVkFMSURfQVRPTV9BUEkiLCJDT05URVhUIiwiU0FNRV9QUk9KRUNUX0lEIiwidHlwZSIsIk5PVF9BX1BST0pFQ1QiLCJpZHMiLCJpbmNsdWRlcyIsIk5PX1ZBTElEX1BST0pFQ1RfSUQiLCJzd2l0Y2hDb250ZXh0IiwiY2F0Y2giLCJyZWFzb24iXSwibWFwcGluZ3MiOiI7Ozs7OztB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eEIsQ0FBUDtBQUNEOztBQUVEbEQsY0FBUTtBQUNOTyx5QkFBaUIsSUFEWDtBQUVOcUIsc0JBQWNkLE9BRlI7QUFHTkUsYUFBSyxJQUhDO0FBSU5FLGVBQU87QUFKRCxPQUFSO0FBTUQsS0F2Qk0sQ0FBUDtBQXdCRDs7QUFFRDs7Ozs7O0FBTUFpQyxnQkFBZXJDLE9BQWYsRUFBd0I7QUFDdEIsV0FBTyxLQUFLMkIsZUFBTCxDQUFxQjNCLE9BQXJCLEVBQ0paLElBREksQ0FDQ0ksV0FBVyxLQUFLRCxXQUFMLENBQWlCQyxPQUFqQixDQURaLEVBRUpKLElBRkksQ0FFQ0ksV0FBVyxLQUFLb0IsV0FBTCxDQUFpQnBCLE9BQWpCLENBRlosRUFHSjhDLEtBSEksQ0FHRUMsVUFBVSxzQkFBTyxpQkFBUCxFQUEwQkEsTUFBMUIsQ0FIWixDQUFQO0FBSUQ7QUFqTG1CLEM7a0JBb0xQbkUsZSIsImZpbGUiOiJjb250ZXh0LXN3aXRjaGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGRldmxvZyBmcm9tICcuL2RldmxvZyc7XG5pbXBvcnQgRGF0YWJhc2UgZnJvbSAnLi9kYXRhYmFzZSc7XG5pbXBvcnQgUGFja2FnZXMgZnJvbSAnLi9wYWNrYWdlcyc7XG5pbXBvcnQgeyBQTFVHSU5fTkFNRSwgTUVTU0FHRVMgfSBmcm9tICcuLy4uL2NvbnN0YW50cy9iYXNlJztcblxuLyoqXG4gKiBDbGFzcyByZXByZXNlbnRpbmcgdGhlIERhdGFiYXNlXG4gKi9cbmNsYXNzIENvbnRleHRTd2l0Y2hlciB7XG5cbiAgc3RhdGljIGluc3RhbmNlO1xuXG4gIC8qKlxuICAgKiBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBAdG9kbyBpbXByb3ZlIEpTRG9jXG4gICAqL1xuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgaWYgKENvbnRleHRTd2l0Y2hlci5pbnN0YW5jZSkge1xuICAgICAgcmV0dXJuIENvbnRleHRTd2l0Y2hlci5pbnN0YW5jZTtcbiAgICB9XG4gICAgQ29udGV4dFN3aXRjaGVyLmluc3RhbmNlID0gdGhpcztcblxuICAgIHRoaXMuZGF0YWJhc2UgPSBuZXcgRGF0YWJhc2UoKTtcbiAgICB0aGlzLnBhY2thZ2VzID0gbmV3IFBhY2thZ2VzKCk7XG4gIH1cblxuICAvKipcbiAgICogZGVzY3JpcHRpb25cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IHN0YXRlcyAtIGRlc2NyaXB0aW9uXG4gICAqL1xuICBzYXZlUGFja2FnZXMgKHN0YXRlcykge1xuICAgIHN0YXRlcy50cmVlVmlldyA9IHRoaXMucGFja2FnZXMudHJlZVZpZXcuc2F2ZSgpO1xuICAgIHN0YXRlcy5maW5kQW5kUmVwbGFjZSA9IHRoaXMucGFja2FnZXMuZmluZEFuZFJlcGxhY2Uuc2F2ZSgpO1xuICAgIHRoaXMucGFja2FnZXMubGludGVyVUlEZWZhdWx0LnNhdmUoKTtcbiAgICB0aGlzLnBhY2thZ2VzLmxpbnRlci5zYXZlKCk7XG4gIH1cblxuICAvKipcbiAgICogZGVzY3JpcHRpb25cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IHN0YXRlcyAtIGRlc2NyaXB0aW9uXG4gICAqIEByZXR1cm5zIHtQcm9taXNlfSBkZXNjcmlwdGlvblxuICAgKi9cbiAgbG9hZE9yUmVsb2FkUGFja2FnZXMgKHN0YXRlcykge1xuICAgIGlmICghc3RhdGVzKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnBhY2thZ2VzLnRyZWVWaWV3LmxvYWQoc3RhdGVzLnRyZWVWaWV3KVxuICAgICAgLnRoZW4oKCkgPT4gdGhpcy5wYWNrYWdlcy5maW5kQW5kUmVwbGFjZS5sb2FkKHN0YXRlcy5maW5kQW5kUmVwbGFjZSkpXG4gICAgICAudGhlbigoKSA9PiB0aGlzLnBhY2thZ2VzLnN0YXR1c0Jhci5yZWxvYWQoKSlcbiAgICAgIC50aGVuKCgpID0+IHRoaXMucGFja2FnZXMubGludGVyLmxvYWQoKSlcbiAgICAgIC50aGVuKCgpID0+IHRoaXMucGFja2FnZXMubGludGVyVUlEZWZhdWx0LmxvYWQoKSk7XG4gIH1cblxuICAvKipcbiAgICogZGVzY3JpcHRpb25cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgLSBkZXNjcmlwdGlvblxuICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gZGVzY3JpcHRpb25cbiAgICovXG4gIHNhdmVDb250ZXh0IChjb250ZXh0KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgY29udGV4dC5jdXJyZW50X3Byb2plY3QgPSB0aGlzLmRhdGFiYXNlLmNvbnRlbnQuc2VsZWN0ZWRJZCA/XG4gICAgICAgIHRoaXMuZGF0YWJhc2UuY29udGVudC5tYXBbdGhpcy5kYXRhYmFzZS5jb250ZW50LnNlbGVjdGVkSWRdIDpcbiAgICAgICAgeyBtb2RlbDogeyBwYXRoczogYXRvbS5wcm9qZWN0LmdldFBhdGhzKCkgfSB9O1xuXG4gICAgICBkZXZsb2coJ3N0YXJ0IHNhdmUgY29udGV4dCcsIGNvbnRleHQuY3VycmVudF9wcm9qZWN0KTtcblxuICAgICAgY29udGV4dC5rZXkgPSBhdG9tLmdldFN0YXRlS2V5KGNvbnRleHQuY3VycmVudF9wcm9qZWN0Lm1vZGVsLnBhdGhzKTtcblxuICAgICAgY29udGV4dC5zdGF0ZSA9IGF0b20uc2VyaWFsaXplKCk7XG5cbiAgICAgIGNvbnRleHQuZG9ja2VyID0gYXRvbS53b3Jrc3BhY2UuZ2V0Q2VudGVyKCk7XG5cbiAgICAgIGNvbnRleHQuc3RhdGUuZXh0cmFTdGF0ZXMgPSB7fTtcblxuICAgICAgaWYgKGNvbnRleHQua2V5ICYmIGNvbnRleHQuc3RhdGUpIHtcbiAgICAgICAgdGhpcy5zYXZlUGFja2FnZXMoY29udGV4dC5zdGF0ZS5leHRyYVN0YXRlcyk7XG4gICAgICAgIGF0b20uZ2V0U3RvcmFnZUZvbGRlcigpLnN0b3JlU3luYyhjb250ZXh0LmtleSwgY29udGV4dC5zdGF0ZSk7XG4gICAgICB9XG5cbiAgICAgIGRldmxvZygnZW5kIHNhdmUgY29udGV4dCcsIGNvbnRleHQpO1xuXG4gICAgICByZXNvbHZlKGNvbnRleHQpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IC0gZGVzY3JpcHRpb25cbiAgICogQHJldHVybnMge1Byb21pc2V9IGRlc2NyaXB0aW9uXG4gICAqL1xuICBsb2FkQ29udGV4dCAoY29udGV4dCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBkZXZsb2coJ3N0YXJ0IGxvYWQgY29udGV4dCcsIGNvbnRleHQubmV4dF9wcm9qZWN0KTtcblxuICAgICAgY29udGV4dC5rZXkgPSBhdG9tLmdldFN0YXRlS2V5KGNvbnRleHQubmV4dF9wcm9qZWN0Lm1vZGVsLnBhdGhzKTtcbiAgICAgIGNvbnRleHQuc3RhdGUgPSBhdG9tLmdldFN0b3JhZ2VGb2xkZXIoKS5sb2FkKGNvbnRleHQua2V5KTtcblxuICAgICAgaWYgKFxuICAgICAgICAhY29udGV4dC5zdGF0ZSB8fFxuICAgICAgICBhdG9tLmdldFN0YXRlS2V5KGNvbnRleHQuc3RhdGUucHJvamVjdC5wYXRocykgIT09IGNvbnRleHQua2V5XG4gICAgICApIHtcbiAgICAgICAgYXRvbS5wcm9qZWN0LnNldFBhdGhzKGNvbnRleHQubmV4dF9wcm9qZWN0Lm1vZGVsLnBhdGhzKTtcblxuICAgICAgICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UuZ2V0Q2VudGVyKCkucGFuZUNvbnRhaW5lci5hY3RpdmVQYW5lO1xuXG4gICAgICAgIGlmIChwYW5lKSB7XG4gICAgICAgICAgcGFuZS5kZXN0cm95KCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmRhdGFiYXNlLmNvbnRlbnQuc2VsZWN0ZWRJZCA9IGNvbnRleHQubmV4dF9wcm9qZWN0LmlkO1xuXG4gICAgICAgIGNvbnRleHQuY3VycmVudF9wcm9qZWN0LnNlbGVjdGVkID0gZmFsc2U7XG4gICAgICAgIGNvbnRleHQubmV4dF9wcm9qZWN0LnNlbGVjdGVkID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gcmVzb2x2ZShjb250ZXh0KTtcbiAgICAgIH1cblxuICAgICAgYXRvbS5wcm9qZWN0LmRlc2VyaWFsaXplKGNvbnRleHQuc3RhdGUucHJvamVjdClcbiAgICAgICAgLnRoZW4oKCkgPT4gYXRvbS53b3Jrc3BhY2UuZ2V0Q2VudGVyKCkuZGVzZXJpYWxpemUoXG4gICAgICAgICAgY29udGV4dC5zdGF0ZS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lcnMuY2VudGVyLCBhdG9tLmRlc2VyaWFsaXplcnNcbiAgICAgICAgKSlcbiAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5sb2FkT3JSZWxvYWRQYWNrYWdlcyhjb250ZXh0LnN0YXRlLmV4dHJhU3RhdGVzKSlcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHRoaXMuZGF0YWJhc2UuY29udGVudC5zZWxlY3RlZElkID0gY29udGV4dC5uZXh0X3Byb2plY3QuaWQ7XG5cbiAgICAgICAgICBjb250ZXh0LmN1cnJlbnRfcHJvamVjdC5zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgICAgIGNvbnRleHQubmV4dF9wcm9qZWN0LnNlbGVjdGVkID0gdHJ1ZTtcblxuICAgICAgICAgIC8vIFRPRE86IHRoaXMgaXMgYmFkIGZvciBwZXJmb3JtYW5jZVxuICAgICAgICAgIHRoaXMuZGF0YWJhc2UudXBkYXRlKCk7XG5cbiAgICAgICAgICBkZXZsb2coJ2VuZCBsb2FkIGNvbnRleHQnKTtcblxuICAgICAgICAgIHJlc29sdmUoY29udGV4dCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBwcm9qZWN0IC0gZGVzY3JpcHRpb25cbiAgICogQHJldHVybnMge1Byb21pc2V9IGRlc2NyaXB0aW9uXG4gICAqL1xuICB2YWxpZGF0ZUNvbnRleHQgKHByb2plY3QpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaWYgKCFhdG9tLmdldFN0b3JhZ2VGb2xkZXIpIHtcbiAgICAgICAgcmVqZWN0KE1FU1NBR0VTLkFUT00uSU5WQUxJRF9BVE9NX0FQSSk7XG4gICAgICB9XG5cbiAgICAgIGVsc2UgaWYgKHByb2plY3QuaWQgPT09IHRoaXMuZGF0YWJhc2UuY29udGVudC5zZWxlY3RlZElkKSB7XG4gICAgICAgIHJlamVjdChNRVNTQUdFUy5DT05URVhULlNBTUVfUFJPSkVDVF9JRCk7XG4gICAgICB9XG5cbiAgICAgIGVsc2UgaWYgKHByb2plY3QudHlwZSAhPT0gJ3Byb2plY3QnKSB7XG4gICAgICAgIHJldHVybiByZWplY3QoTUVTU0FHRVMuQ09OVEVYVC5OT1RfQV9QUk9KRUNUKTtcbiAgICAgIH1cblxuICAgICAgZWxzZSBpZiAoIXRoaXMuZGF0YWJhc2UuY29udGVudC5pZHMuaW5jbHVkZXMocHJvamVjdC5pZCkpIHtcbiAgICAgICAgcmV0dXJuIHJlamVjdChNRVNTQUdFUy5DT05URVhULk5PX1ZBTElEX1BST0pFQ1RfSUQpO1xuICAgICAgfVxuXG4gICAgICByZXNvbHZlKHtcbiAgICAgICAgY3VycmVudF9wcm9qZWN0OiBudWxsLFxuICAgICAgICBuZXh0X3Byb2plY3Q6IHByb2plY3QsXG4gICAgICAgIGtleTogbnVsbCxcbiAgICAgICAgc3RhdGU6IG51bGxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBwcm9qZWN0IC0gZGVzY3JpcHRpb25cbiAgICogQHJldHVybnMge1Byb21pc2V9IGRlc2NyaXB0aW9uXG4gICAqL1xuICBzd2l0Y2hDb250ZXh0IChwcm9qZWN0KSB7XG4gICAgcmV0dXJuIHRoaXMudmFsaWRhdGVDb250ZXh0KHByb2plY3QpXG4gICAgICAudGhlbihjb250ZXh0ID0+IHRoaXMuc2F2ZUNvbnRleHQoY29udGV4dCkpXG4gICAgICAudGhlbihjb250ZXh0ID0+IHRoaXMubG9hZENvbnRleHQoY29udGV4dCkpXG4gICAgICAuY2F0Y2gocmVhc29uID0+IGRldmxvZygnc3dpdGNoaW5nIGVycm9yJywgcmVhc29uKSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQ29udGV4dFN3aXRjaGVyO1xuIl19